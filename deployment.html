<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>מערכת בקשות העברת גרסאות Power Apps</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'iec-blue': '#1e87f0',
                        'iec-green': '#28a745',
                        'iec-red': '#dc3545',
                        'iec-orange': '#fd7e14',
                        'iec-yellow': '#ffc107',
                    }
                }
            }
        }
    </script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" 
          integrity="sha512-Avb2QiuDEEvB4bZJYdft2mNjVShBftLdPG8FJ0V7irTLQ8Uo0qcPxh4Plq7G5tGm0rU+1SPhVotteLpBERwTkw==" 
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.16.3/dist/css/uikit.min.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.16.3/dist/js/uikit.min.js"></script>
    <style>
        /*
        Icon Libraries Available:
        
        1. Font Awesome 6 (Free):
           Usage: <i class="fas fa-icon-name"></i>
           Examples: fa-user, fa-envelope, fa-lock, fa-check, fa-times
           
        2. Google Material Icons:
           Usage: <span class="icon-material">icon_name</span>
           Examples: add, delete, edit, settings, home
           
        3. Google Material Symbols Outlined:
           Usage: <span class="icon-material-outlined">icon_name</span>
           Examples: add, delete, edit, settings, home
           
        4. UIKit Icons (original):
           Usage: <span uk-icon="icon-name"></span>
           Examples: user, plus, minus, check, close
        */
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            direction: rtl;
            /* Better mobile scrolling */
            -webkit-overflow-scrolling: touch;
            /* Disable text selection on mobile for better UX */
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
        }

        .uk-navbar-container {
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-bottom: 1px solid #e5e5e5;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #1e87f0, #0f6ecd);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            margin-left: 10px;
        }

        .nav-mobile {
            display: none;
        }

        .user-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Responsive navbar adjustments */
        @media (max-width: 768px) {
            .uk-navbar-center {
                display: none;
            }
            
            .nav-mobile {
                display: block;
                width: 100%;
                background: #f8f9fa;
                border-top: 1px solid #e5e5e5;
                padding: 10px;
            }
            
            .uk-navbar-item .uk-text-large {
                font-size: 1rem !important;
            }
            
            .logo-icon {
                width: 32px;
                height: 32px;
                font-size: 1rem;
            }
            
            .user-controls {
                flex-direction: column;
                gap: 5px;
            }
            
            .user-controls button {
                width: 100%;
                min-width: 120px;
            }
        }

        @media (max-width: 480px) {
            .uk-navbar-item .uk-text-large {
                display: none;
            }
            
            .uk-navbar-left .uk-navbar-item {
                padding: 0 10px;
            }
        }

        .request-item {
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #fff;
            transition: all 0.2s ease;
        }

        .request-item:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .urgency-high {
            border-right: 4px solid #f0506e;
        }

        .urgency-critical {
            border-right: 4px solid #8b0000;
            background: rgba(240, 80, 110, 0.02);
        }

        .status-pending {
            background: rgba(255, 181, 0, 0.1);
            color: #b8860b;
        }

        .status-approved {
            background: rgba(50, 207, 115, 0.1);
            color: #32cf73;
        }

        .status-rejected {
            background: rgba(240, 80, 110, 0.1);
            color: #f0506e;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        @media (max-width: 640px) {
            .detail-grid {
                grid-template-columns: 1fr;
                gap: 10px;
                margin: 10px 0;
            }
        }
        
        @media (min-width: 641px) and (max-width: 960px) {
            .detail-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .detail-label {
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
            font-weight: 500;
        }

        .detail-value {
            font-size: 0.875rem;
            color: #333;
            font-weight: 500;
        }
        
        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(0,0,0,0.4);
        }
        
        @media (max-width: 640px) {
            .fab {
                bottom: 20px;
                right: 20px;
                width: 56px;
                height: 56px;
            }
        }
        
        /* Header improvements */
        .main-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo-icon {
            font-size: 2rem;
            background: rgba(255,255,255,0.2);
            padding: 0.5rem;
            border-radius: 50%;
        }
        
        .header-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
        }
        
        .header-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin: 0;
        }
        
        .admin-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        @media (max-width: 768px) {
            .main-header {
                padding: 1.5rem 0;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .header-title {
                font-size: 1.5rem;
            }
        }
        
        /* Remove tab styles - no longer needed */
        
        /* Additional responsive improvements */
        @media (max-width: 640px) {
            .uk-container {
                padding: 0 10px;
            }
            
            .uk-card-body {
                padding: 15px;
            }
            
            .uk-button {
                min-height: 44px; /* Better touch targets on mobile */
            }
            
            .uk-form-controls {
                margin-bottom: 15px;
            }
            
            .uk-text-large {
                font-size: 1.1rem;
            }
            
            /* Enhanced mobile form styling */
            .uk-form-label {
                font-size: 0.9rem;
                font-weight: 600;
                margin-bottom: 8px;
                display: block;
            }
            
            .uk-input, .uk-select, .uk-textarea {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 12px;
                border-radius: 8px;
            }
            
            /* Mobile header improvements */
            .main-header {
                padding: 1rem 0;
            }
            
            .header-title {
                font-size: 1.3rem !important;
            }
            
            .header-subtitle {
                font-size: 0.85rem !important;
            }
            
            .admin-controls {
                flex-direction: column;
                gap: 8px;
                width: 100%;
            }
            
            .admin-controls button {
                width: 100%;
                justify-content: center;
                font-size: 0.9rem;
            }
            
            /* Mobile table improvements */
            .uk-table {
                font-size: 0.75rem;
            }
            
            .uk-table th,
            .uk-table td {
                padding: 8px 4px;
                vertical-align: middle;
            }
            
            .expand-btn {
                padding: 2px !important;
                min-width: 28px !important;
                min-height: 28px !important;
            }
            
            .uk-button-small {
                padding: 4px 8px;
                font-size: 0.7rem;
            }
            
            /* Mobile badge adjustments */
            .uk-badge {
                font-size: 0.65rem;
                padding: 2px 6px;
            }
            
            /* Mobile FAB adjustments */
            .fab {
                bottom: 15px;
                right: 15px;
                width: 52px;
                height: 52px;
                font-size: 1.2rem;
            }
            
            /* Mobile card improvements */
            .uk-card {
                margin-bottom: 15px;
                border-radius: 12px;
            }
            
            .uk-card-header {
                padding: 15px;
            }
            
            .uk-card-title {
                font-size: 1.1rem;
            }
        }
        
        @media (min-width: 641px) and (max-width: 960px) {
            .uk-container {
                padding: 0 20px;
            }
            
            /* Tablet-specific adjustments */
            .admin-controls {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .admin-controls button {
                min-width: 140px;
            }
            
            .header-title {
                font-size: 1.6rem;
            }
            
            .uk-table {
                font-size: 0.85rem;
            }
            
            .fab {
                width: 56px;
                height: 56px;
                bottom: 25px;
                right: 25px;
            }
        }
        
        /* Improve form layout on mobile */
        @media (max-width: 640px) {
            .uk-grid > * {
                padding-left: 0;
            }
            
            .uk-form-label {
                margin-bottom: 5px;
                font-weight: 600;
            }
        }
        
        /* Grid Table Styles */
        .request-row {
            transition: background-color 0.2s ease;
        }
        
        .request-row:hover {
            background-color: #f8f9fa;
        }
        
        .request-row.urgency-high {
            border-left: 4px solid #f0ad4e;
        }
        
        .request-row.urgency-critical {
            border-left: 4px solid #d9534f;
        }
        
        .expand-btn {
            transition: transform 0.2s ease;
            padding: 5px !important;
            min-width: 30px;
            min-height: 30px;
        }
        
        .expand-btn:hover {
            background-color: #f8f9fa;
            border-radius: 3px;
        }
        
        .details-row {
            transition: all 0.3s ease;
        }
        
        .details-row td {
            border-top: none !important;
        }
        
        .details-row .detail-label {
            font-size: 0.8rem;
            color: #666;
            font-weight: 600;
            margin-bottom: 2px;
            display: block;
        }
        
        .details-row .detail-value {
            font-size: 0.9rem;
            color: #333;
        }
        
        /* Table header improvements */
        .uk-table th {
            text-align: center;
            vertical-align: middle;
            background-color: #f8f9fa;
            border-bottom: 2px solid #e5e5e5;
            font-weight: 600;
            padding: 12px 8px;
        }
        
        .uk-table td {
            text-align: center;
            vertical-align: middle;
            padding: 10px 8px;
        }
        
        /* Sortable column headers */
        .sortable-header {
            cursor: pointer;
            position: relative;
            user-select: none;
            transition: background-color 0.2s ease;
        }
        
        .sortable-header:hover {
            background-color: #e9ecef;
        }
        
        .sortable-header.sort-asc::after {
            content: ' ▲';
            color: #1e87f0;
            font-size: 0.8em;
        }
        
        .sortable-header.sort-desc::after {
            content: ' ▼';
            color: #1e87f0;
            font-size: 0.8em;
        }
        
        .sortable-header:not(.sort-asc):not(.sort-desc)::after {
            content: ' ⇅';
            color: #999;
            font-size: 0.8em;
            opacity: 0.5;
        }
        
        .sortable-header:hover::after {
            opacity: 1;
        }
        
        /* Icon Styles for Font Awesome and Material Icons */
        .icon-fa {
            font-family: 'Font Awesome 6 Free', 'Font Awesome 6 Brands', 'Font Awesome 6 Pro';
            font-weight: 900;
        }
        
        .icon-material {
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            font-feature-settings: 'liga';
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
        }
        
        .icon-material-outlined {
            font-family: 'Material Symbols Outlined';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            font-feature-settings: 'liga';
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
        }
        
        /* Button icon spacing */
        .btn-icon {
            margin-left: 8px;
            vertical-align: middle;
        }
        
        .btn-icon-right {
            margin-right: 8px;
            vertical-align: middle;
        }
        
        /* Dark Mode Styles */
        .dark {
            background-color: #111827;
            color: #f9fafb;
        }
        
        .dark body {
            background-color: #111827;
        }
        
        /* Background overrides for dark mode */
        .dark .bg-gray-50 {
            background-color: #1f2937;
        }
        
        .dark .bg-gray-100 {
            background-color: #374151;
        }
        
        .dark .bg-gray-200 {
            background-color: #4b5563;
        }
        
        .dark .bg-white {
            background-color: #1f2937;
        }
        
        /* Text color overrides for dark mode */
        .dark .text-gray-900 {
            color: #f9fafb;
        }
        
        .dark .text-gray-800 {
            color: #e5e7eb;
        }
        
        .dark .text-gray-700 {
            color: #d1d5db;
        }
        
        .dark .text-gray-600 {
            color: #9ca3af;
        }
        
        .dark .text-gray-500 {
            color: #6b7280;
        }
        
        .dark .text-gray-400 {
            color: #9ca3af;
        }
        
        /* Border color overrides for dark mode */
        .dark .border-gray-200 {
            border-color: #4b5563;
        }
        
        .dark .border-gray-300 {
            border-color: #6b7280;
        }
        
        .dark .border-gray-400 {
            border-color: #9ca3af;
        }
        
        /* Shadow overrides for dark mode */
        .dark .shadow-sm {
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
        }
        
        .dark .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
        }
        
        .dark .shadow-xl {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
        }
        
        /* Hover effects for dark mode */
        .dark .hover\:bg-gray-50:hover {
            background-color: #374151;
        }
        
        .dark .hover\:bg-gray-100:hover {
            background-color: #4b5563;
        }
        
        .dark .hover\:bg-gray-200:hover {
            background-color: #6b7280;
        }
        
        /* Divide colors for dark mode */
        .dark .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
            border-color: #4b5563;
        }
        
        /* UIKit button overrides for dark mode */
        .dark .uk-button-default {
            background-color: #4b5563;
            color: #f9fafb;
            border-color: #6b7280;
        }
        
        .dark .uk-button-default:hover {
            background-color: #6b7280;
            color: #f9fafb;
        }
        
        /* Form elements dark mode */
        .dark input, 
        .dark select, 
        .dark textarea {
            background-color: #374151;
            border-color: #4b5563;
            color: #f9fafb;
        }
        
        .dark input:focus, 
        .dark select:focus, 
        .dark textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Drag submit dark mode */
        .dark .drag-submit-track {
            background: linear-gradient(90deg, #374151 0%, #4b5563 100%);
            border-color: #6b7280;
        }
        
        .dark .drag-submit-track.disabled {
            background: linear-gradient(90deg, #1f2937 0%, #374151 100%);
        }
        
        .dark .drag-submit-text {
            color: #d1d5db;
        }
        
        .dark .drag-submit-text.disabled,
        .dark .drag-submit-text-disabled {
            color: #6b7280;
        }
        
        #dark-mode-toggle {
            transition: all 0.3s ease;
        }
        
        #dark-mode-toggle:hover {
            transform: scale(1.05);
        }
        
        /* Status icons */
        .status-icon {
            font-size: 1.2em;
            vertical-align: middle;
            margin-left: 5px;
        }
        
            .urgency-icon {
                font-size: 1em;
                vertical-align: middle;
                margin-left: 3px;
            }
            
        /* Extra small mobile devices */
        @media (max-width: 480px) {
            .main-header {
                padding: 0.8rem 0;
            }
            
            .header-content {
                text-align: center;
            }
            
            .logo-section {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .logo-icon {
                width: 35px;
                height: 35px;
                font-size: 1rem;
                margin: 0 auto;
            }
            
            .header-title {
                font-size: 1.1rem !important;
                margin: 0;
            }
            
            .header-subtitle {
                font-size: 0.8rem !important;
                margin: 0;
            }
            
            .admin-controls {
                margin-top: 15px;
                gap: 6px;
            }
            
            .admin-controls button {
                font-size: 0.8rem;
                padding: 8px 12px;
            }
            
            /* Ultra compact table for very small screens */
            .uk-table th:nth-child(n+4),
            .uk-table td:nth-child(n+4) {
                display: none;
            }
            
            /* Show only ID, App ID, and Status on very small screens */
            .uk-table th:nth-child(2),
            .uk-table td:nth-child(2),
            .uk-table th:nth-child(3),
            .uk-table td:nth-child(3),
            .uk-table th:nth-child(7),
            .uk-table td:nth-child(7) {
                display: table-cell;
            }
            
            .uk-table {
                font-size: 0.7rem;
            }
            
            
            .fab {
                width: 48px;
                height: 48px;
                bottom: 10px;
                right: 10px;
                font-size: 1.1rem;
            }
            
            /* Stack form elements vertically on very small screens */
            .uk-grid-small > * {
                width: 100% !important;
                margin-top: 10px;
            }
            
            .uk-grid-small > *:first-child {
                margin-top: 0;
            }
        }        /* Mobile responsive for table */
        @media (max-width: 768px) {
            .uk-table th:nth-child(4),
            .uk-table td:nth-child(4) {
                display: none;
            }
            
            .uk-table th:nth-child(7),
            .uk-table td:nth-child(7) {
                display: none;
            }
        }
        
        @media (max-width: 640px) {
            .uk-table th:nth-child(3),
            .uk-table td:nth-child(3),
            .uk-table th:nth-child(6),
            .uk-table td:nth-child(6) {
                display: none;
            }
            
            .uk-table {
                font-size: 0.8rem;
            }
        }
        
        /* Environment Selection Enhancements */
        #environmentFlow {
            transition: all 0.3s ease;
        }
        
        #environmentFlow:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        /* Environment circles animation */
        .env-circle {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .env-circle:hover {
            transform: scale(1.05);
        }
        
        /* Arrow animations */
        #arrow-1, #arrow-2 {
            transition: all 0.3s ease;
        }
        
        /* Flow status animation */
        #flowStatus {
            animation: slideInFromTop 0.4s ease-out;
        }
        
        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Environment validation messages */
        #environmentValidation > div {
            animation: fadeInScale 0.3s ease-out;
        }
        
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-5px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        /* Warning flow styles for dev->prod */
        .warning-flow-arrow {
            color: #f97316 !important; /* orange-500 */
            filter: drop-shadow(0 2px 4px rgba(249, 115, 22, 0.3));
        }
        
        .warning-flow-test {
            border-color: #fed7aa !important; /* orange-200 */
            background-color: rgba(255, 237, 213, 0.5) !important; /* orange-50 with opacity */
        }
        
        /* Enhanced arrow animations */
        @keyframes bounceWarning {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0) scale(1);
            }
            40% {
                transform: translateY(-4px) scale(1.1);
            }
            60% {
                transform: translateY(-2px) scale(1.05);
            }
        }
        
        .animate-bounce-warning {
            animation: bounceWarning 1s ease-in-out infinite;
        }
        
        /* Environment selector enhancements */
        #sourceEnv:focus, #targetEnv:focus {
            transform: scale(1.02);
            box-shadow: 0 0 0 3px rgba(30, 135, 240, 0.1);
        }
        
        /* Help text animation */
        #sourceEnvHelp, #targetEnvHelp {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Environment flow responsive */
        @media (max-width: 640px) {
            #environmentFlow .flex {
                flex-direction: column;
                gap: 1rem;
            }
            
            #environmentFlow .flex > div {
                margin-bottom: 1rem;
            }
            
            #arrow-1, #arrow-2 {
                transform: rotate(90deg);
                margin: 0.5rem 0;
            }
            
            #environmentFlow {
                padding: 1rem;
            }
        }
        
        /* Touch-friendly enhancements */
        @media (hover: none) and (pointer: coarse) {
            /* Mobile/touch devices */
            .request-row:hover {
                background-color: transparent;
            }
            
            .request-row:active {
                background-color: #f8f9fa;
            }
            
            .expand-btn:hover {
                background-color: transparent;
            }
            
            .expand-btn:active {
                background-color: #e9ecef;
                border-radius: 4px;
            }
            
            .uk-button:hover {
                transform: none;
            }
            
            .uk-button:active {
                transform: scale(0.98);
            }
            
            .fab:hover {
                transform: none;
            }
            
            .fab:active {
                transform: scale(0.95);
            }
        }
        
        /* Landscape mobile optimizations */
        @media (max-width: 960px) and (orientation: landscape) {
            .main-header {
                padding: 0.8rem 0;
            }
            
            .header-content {
                flex-direction: row;
                align-items: center;
            }
            
            .admin-controls {
                flex-direction: row;
                flex-wrap: wrap;
            }
        }
        
        /* Swipe Animation Button */
        .submit-btn-swipe {
            position: relative;
            overflow: hidden;
            cursor: pointer;
            border: none;
        }
        
        .submit-btn-swipe:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        
        .submit-btn-swipe:active {
            transform: translateY(0);
        }
        
        .submit-btn-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #1d4ed8, #2563eb);
            transform: translateX(-100%);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .submit-btn-swipe:hover .submit-btn-bg {
            transform: translateX(0);
        }
        
        .submit-btn-swipe:hover .fas.fa-paper-plane {
            animation: plane-fly 0.6s ease-in-out;
        }
        
        @keyframes plane-fly {
            0% {
                transform: translateX(0) rotate(0deg);
            }
            50% {
                transform: translateX(8px) rotate(-10deg);
            }
            100% {
                transform: translateX(0) rotate(0deg);
            }
        }
        
        /* Ripple effect on click */
        .submit-btn-swipe:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        
        /* Drag to Submit Styles */
        .drag-submit-container {
            position: relative;
            user-select: none;
        }
        
        .drag-submit-track {
            position: relative;
            background: linear-gradient(90deg, #e5e7eb 0%, #d1d5db 100%);
            border: 2px solid #d1d5db;
            transition: all 0.3s ease;
        }
        
        .drag-submit-track.dragging {
            background: linear-gradient(90deg, #dbeafe 0%, #bfdbfe 100%);
            border-color: #3b82f6;
        }
        
        .drag-submit-track.completed {
            background: linear-gradient(90deg, #dcfce7 0%, #bbf7d0 100%);
            border-color: #10b981;
        }
        
        .drag-submit-button {
            position: absolute;
            left: 4px;
            top: 50%;
            transform: translateY(-50%);
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        .drag-submit-button:hover {
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        
        .drag-submit-button.dragging {
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6);
            transform: translateY(-50%) scale(1.1);
        }
        
        .drag-submit-text {
            transition: all 0.3s ease;
            pointer-events: none;
        }
        
        .drag-submit-text.fading {
            opacity: 0.5;
            transform: translateX(10px);
        }
        
        .drag-submit-success {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            animation: success-bounce 0.6s ease-out;
        }
        
        @keyframes success-bounce {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .drag-progress {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.2) 0%, rgba(59, 130, 246, 0.1) 100%);
            border-radius: inherit;
            transition: width 0.1s ease;
            pointer-events: none;
        }
        
        /* Disabled drag state */
        .drag-submit-track.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: linear-gradient(90deg, #f3f4f6 0%, #e5e7eb 100%);
        }
        
        .drag-submit-button.disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        
        .drag-submit-button.disabled:hover {
            transform: translateY(-50%) scale(1);
            box-shadow: none;
        }
        
        .drag-submit-text.disabled {
            color: #9ca3af;
        }
    </style>
</head>
<body class="bg-gray-50 font-inter">
    <div class="min-h-screen">
        <!-- Main Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-col sm:flex-row items-center justify-between py-4 space-y-4 sm:space-y-0">
                    <div class="flex items-center space-x-4 rtl:space-x-reverse">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 bg-iec-blue rounded-lg flex items-center justify-center text-white">
                                <i class="fas fa-bolt text-lg"></i>
                            </div>
                        </div>
                        <div class="text-center sm:text-right">
                            <h1 class="text-xl sm:text-2xl font-bold text-gray-900">מערכת בקשות Power Apps</h1>
                            <p class="text-sm text-gray-600">ניהול העברת גרסאות בין סביבות</p>
                        </div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-3 rtl:space-x-reverse">
                        <div id="user-info" class="hidden text-sm font-medium text-gray-700"></div>
                        <button id="dark-mode-toggle" class="uk-button uk-button-default flex items-center space-x-2 rtl:space-x-reverse px-3 py-2 text-sm" onclick="toggleDarkMode()" title="החלף מצב תצוגה">
                            <i id="dark-mode-icon" class="fas fa-moon"></i>
                        </button>
                        <button id="admin-login-btn" class="uk-button uk-button-default flex items-center space-x-2 rtl:space-x-reverse px-4 py-2 text-sm" onclick="showAdminLogin()">
                            <i class="fas fa-user"></i>
                            <span>התחברות מנהל</span>
                        </button>
                        <button id="admin-logout-btn" class="uk-button uk-button-danger hidden flex items-center space-x-2 rtl:space-x-reverse px-4 py-2 text-sm" onclick="adminLogout()">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>התנתק</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <!-- Filter and Search Section -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                <div class="px-4 sm:px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg sm:text-xl font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-list-alt ml-2 text-iec-blue"></i>
                        כל הבקשות
                    </h2>
                    <p class="text-sm text-gray-600 mt-1">צפייה בכל בקשות העברת הגרסאות והסטטוס שלהן</p>
                </div>
                <div class="px-4 sm:px-6 py-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-4 gap-4 mb-6">
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">חיפוש</label>
                            <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-iec-blue focus:border-iec-blue text-sm" id="searchInput" placeholder="חפש לפי מזהה, אפליקציה או מבקש..." onkeyup="filterRequests()">
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">סינון לפי סטטוס</label>
                            <select class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-iec-blue focus:border-iec-blue text-sm" id="statusFilter" onchange="loadAllRequests(); filterRequests();">
                                <option value="">כל הסטטוסים</option>
                                <option value="pending" selected>ממתין לביצוע</option>
                                <option value="approved">בוצע</option>
                                <option value="rejected">נדחה</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">סינון לפי תאריך</label>
                            <div class="flex gap-2">
                                <button class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-md transition-colors duration-200 focus:ring-iec-blue focus:border-iec-blue" 
                                        id="todayFilterBtn" 
                                        onclick="toggleDateFilter(true)"
                                        style="background-color: #3B82F6; color: white; border-color: #3B82F6;">
                                    רק היום
                                </button>
                                <button class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-md transition-colors duration-200 focus:ring-iec-blue focus:border-iec-blue" 
                                        id="allDatesBtn" 
                                        onclick="toggleDateFilter(false)"
                                        style="background-color: #F3F4F6; color: #374151;">
                                    כל התאריכים
                                </button>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700 sm:hidden">&nbsp;</label>
                            <button class="w-full sm:w-auto px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-md shadow-sm transition-colors duration-200 flex items-center justify-center space-x-2 rtl:space-x-reverse text-sm" onclick="loadAllRequests()">
                                <i class="fas fa-sync-alt"></i>
                                <span>רענן רשימה</span>
                            </button>
                        </div>
                    </div>
                    <div id="allRequests" class="overflow-x-auto"></div>
                </div>
            </div>
            
            <!-- Floating Action Button -->
            <button class="fixed bottom-6 right-6 w-14 h-14 bg-iec-blue hover:bg-blue-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center z-50 md:w-16 md:h-16" onclick="showNewRequestModal()" title="הגשת בקשה חדשה">
                <span class="icon-material text-xl md:text-2xl">add</span>
            </button>
        </div>

        <!-- Message Area -->
        <div id="message" class="fixed top-20 right-4 left-4 z-40 max-w-md mx-auto"></div>

        <!-- New Request Modal -->
        <div id="newRequestModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl max-h-screen overflow-y-auto">
                <button class="absolute top-4 left-4 text-gray-400 hover:text-gray-600 dark:text-gray-300 dark:hover:text-gray-100 transition-colors" type="button" onclick="closeNewRequestModal()">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <div class="p-6">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white mb-2 flex items-center">
                        <i class="fas fa-plus-circle text-iec-blue ml-2"></i>
                        הגשת בקשה חדשה
                    </h2>
                    <p class="text-gray-600 dark:text-gray-300 mb-6">הגש בקשה להעברת Power Apps בין סביבות</p>
                    
                    <form id="submitForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300" for="requesterName">שם המבקש *</label>
                                <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:ring-iec-blue focus:border-iec-blue" id="requesterName" required onchange="updateRequesterEmail()">
                                    <option value="">בחר משתמש</option>
                                </select>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300" for="requesterEmail">אימייל המבקש *</label>
                                <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:ring-iec-blue focus:border-iec-blue" id="requesterEmail" required onchange="updateRequesterName()">
                                    <option value="">בחר אימייל</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300" for="appId">מזהה האפליקציה (App ID) *</label>
                                <input class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:ring-iec-blue focus:border-iec-blue" type="text" id="appId" required>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300" for="urgency">דחיפות *</label>
                                <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:ring-iec-blue focus:border-iec-blue" id="urgency" required>
                                    <option value="low">נמוכה</option>
                                    <option value="medium" selected>בינונית</option>
                                    <option value="high">גבוהה</option>
                                    <option value="critical">קריטית</option>
                                </select>
                            </div>
                        </div>

                        <!-- Environment Selection with Visual Feedback -->
                        <div class="space-y-4">
                            <div class="text-center mb-4">
                                <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">בחירת סביבות העברה</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">בחר את סביבת המקור והיעד להעברת האפליקציה</p>
                            </div>
                            
                            <!-- Environment Visual Flow -->
                            <div id="environmentFlow" class="bg-gradient-to-r from-blue-50 to-green-50 border-2 border-dashed border-gray-300 rounded-lg p-6 mb-4">
                                <div class="flex items-center justify-center space-x-8 rtl:space-x-reverse">
                                    <!-- Dev Environment -->
                                    <div id="env-dev" class="flex flex-col items-center space-y-2 transition-all duration-300 opacity-50">
                                        <div class="w-16 h-16 bg-gray-100 border-2 border-gray-300 rounded-full flex items-center justify-center">
                                            <i class="fas fa-code text-gray-600 text-xl"></i>
                                        </div>
                                        <span class="text-sm font-medium text-gray-700">פיתוח</span>
                                        <span class="text-xs text-gray-500">Dev</span>
                                    </div>
                                    
                                    <!-- Arrow 1 -->
                                    <div id="arrow-1" class="text-gray-400 text-2xl transition-all duration-300">
                                        <i class="fas fa-arrow-left"></i>
                                    </div>
                                    
                                    <!-- Test Environment -->
                                    <div id="env-test" class="flex flex-col items-center space-y-2 transition-all duration-300 opacity-50">
                                        <div class="w-16 h-16 bg-gray-100 border-2 border-gray-300 rounded-full flex items-center justify-center">
                                            <i class="fas fa-flask text-gray-600 text-xl"></i>
                                        </div>
                                        <span class="text-sm font-medium text-gray-700">בדיקות</span>
                                        <span class="text-xs text-gray-500">Test</span>
                                    </div>
                                    
                                    <!-- Arrow 2 -->
                                    <div id="arrow-2" class="text-gray-400 text-2xl transition-all duration-300">
                                        <i class="fas fa-arrow-left"></i>
                                    </div>
                                    
                                    <!-- Prod Environment -->
                                    <div id="env-prod" class="flex flex-col items-center space-y-2 transition-all duration-300 opacity-50">
                                        <div class="w-16 h-16 bg-gray-100 border-2 border-gray-300 rounded-full flex items-center justify-center">
                                            <i class="fas fa-globe text-gray-600 text-xl"></i>
                                        </div>
                                        <span class="text-sm font-medium text-gray-700">ייצור</span>
                                        <span class="text-xs text-gray-500">Prod</span>
                                    </div>
                                </div>
                                
                                <!-- Dynamic Status Message -->
                                <div id="flowStatus" class="text-center mt-4 hidden">
                                    <div class="inline-flex items-center px-4 py-2 bg-white border border-gray-200 rounded-full shadow-sm">
                                        <i class="fas fa-route text-blue-500 ml-2"></i>
                                        <span id="flowStatusText" class="text-sm font-medium text-gray-700"></span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="space-y-2">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300" for="sourceEnv">
                                        <i class="fas fa-upload text-gray-400 ml-1"></i>
                                        סביבת מקור *
                                    </label>
                                    <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:ring-iec-blue focus:border-iec-blue transition-all duration-200" id="sourceEnv" required>
                                        <option value="">בחר סביבת מקור</option>
                                        <option value="dev">🧑‍💻 פיתוח (Development)</option>
                                        <option value="test">🧪 בדיקות (Test)</option>
                                    </select>
                                    <div id="sourceEnvHelp" class="text-xs text-gray-500 hidden">
                                        <i class="fas fa-info-circle ml-1"></i>
                                        <span>זוהי הסביבה בה האפליקציה נמצאת כעת</span>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300" for="targetEnv">
                                        <i class="fas fa-download text-gray-400 ml-1"></i>
                                        סביבת יעד *
                                    </label>
                                    <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:ring-iec-blue focus:border-iec-blue transition-all duration-200" id="targetEnv" required>
                                        <option value="">בחר סביבת יעד</option>
                                        <option value="test">🧪 בדיקות (Test)</option>
                                        <option value="prod">🌐 ייצור (Production)</option>
                                    </select>
                                    <div id="targetEnvHelp" class="text-xs text-gray-500 hidden">
                                        <i class="fas fa-info-circle ml-1"></i>
                                        <span>זוהי הסביבה אליה תועבר האפליקציה</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Validation Messages -->
                            <div id="environmentValidation" class="hidden">
                                <!-- Success Message -->
                                <div id="validCombination" class="bg-green-50 border border-green-200 rounded-md p-3 hidden">
                                    <div class="flex items-start">
                                        <i class="fas fa-check-circle text-green-500 mt-0.5 ml-2"></i>
                                        <div class="text-sm text-green-800">
                                            <div class="font-semibold">✅ בחירה תקינה!</div>
                                            <div id="validCombinationText" class="mt-1"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Warning Message -->
                                <div id="invalidCombination" class="bg-red-50 border border-red-200 rounded-md p-3 hidden">
                                    <div class="flex items-start">
                                        <i class="fas fa-exclamation-triangle text-red-500 mt-0.5 ml-2"></i>
                                        <div class="text-sm text-red-800">
                                            <div class="font-semibold">⚠️ בחירה לא תקינה!</div>
                                            <div id="invalidCombinationText" class="mt-1"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Info Message -->
                                <div id="recommendedFlow" class="bg-blue-50 border border-blue-200 rounded-md p-3 hidden">
                                    <div class="flex items-start">
                                        <i class="fas fa-lightbulb text-blue-500 mt-0.5 ml-2"></i>
                                        <div class="text-sm text-blue-800">
                                            <div class="font-semibold">💡 המלצה:</div>
                                            <div class="mt-1">מסלול הקידום המומלץ: פיתוח → בדיקות → ייצור</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300" for="description">תיאור השינויים *</label>
                            <textarea class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md shadow-sm focus:ring-iec-blue focus:border-iec-blue" id="description" rows="4" required placeholder="תאר את השינויים או הסיבה להעברה"></textarea>
                        </div>

                        <div class="flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0 sm:space-x-3 rtl:space-x-reverse">
                            <!-- Drag to Submit Button -->
                            <div class="drag-submit-container relative">
                                <div class="drag-submit-track bg-gray-200 rounded-full h-12 flex items-center justify-between px-2 min-w-[200px]">
                                    <div class="drag-submit-button bg-iec-blue rounded-full w-10 h-10 flex items-center justify-center cursor-grab active:cursor-grabbing transition-all duration-200 shadow-md">
                                        <i class="fas fa-paper-plane text-white text-sm"></i>
                                    </div>
                                    <span class="drag-submit-text text-gray-600 text-sm font-medium ml-4">גרור לשליחה</span>
                                    <span class="drag-submit-text-disabled hidden text-gray-500 text-sm font-medium ml-4">השלם את השדות הנדרשים</span>
                                </div>
                                <div class="drag-submit-success hidden bg-green-500 rounded-full h-12 flex items-center justify-center min-w-[200px]">
                                    <span class="text-white font-medium flex items-center space-x-2 rtl:space-x-reverse">
                                        <i class="fas fa-check"></i>
                                        <span>נשלח!</span>
                                    </span>
                                </div>
                            </div>

                            <button class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors duration-200 flex items-center justify-center space-x-2 rtl:space-x-reverse" type="button" onclick="closeNewRequestModal()">
                                <i class="fas fa-times"></i>
                                <span>ביטול</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Admin Login Modal -->
        <div id="adminLoginModal" class="uk-modal" uk-modal>
            <div class="uk-modal-dialog uk-modal-body max-w-md mx-4 sm:mx-auto">
                <div class="p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-shield-alt text-iec-blue ml-2"></i>
                        התחברות מנהל
                    </h2>
                    <form id="adminLoginForm" class="space-y-4">
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700 flex items-center" for="adminEmail">
                                <i class="fas fa-envelope text-gray-400 ml-2"></i>
                                אימייל
                            </label>
                            <input class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-iec-blue focus:border-iec-blue" type="email" id="adminEmail" required>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700 flex items-center" for="adminPassword">
                                <i class="fas fa-lock text-gray-400 ml-2"></i>
                                סיסמה
                            </label>
                            <input class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-iec-blue focus:border-iec-blue" type="password" id="adminPassword" required>
                        </div>
                        <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 rtl:space-x-reverse pt-4">
                            <button class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors duration-200 uk-modal-close flex items-center justify-center space-x-2 rtl:space-x-reverse" type="button">
                                <i class="fas fa-times"></i>
                                <span>ביטול</span>
                            </button>
                            <button class="px-6 py-2 bg-iec-blue hover:bg-blue-600 text-white rounded-md transition-colors duration-200 flex items-center justify-center space-x-2 rtl:space-x-reverse" type="submit">
                                <i class="fas fa-sign-in-alt"></i>
                                <span>התחבר</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Reject Request Modal -->
        <div id="rejectModal" class="uk-modal" uk-modal>
            <div class="uk-modal-dialog uk-modal-body max-w-lg mx-4 sm:mx-auto">
                <div class="p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-ban text-iec-red ml-2"></i>
                        דחיית בקשה
                    </h2>
                    <form id="rejectForm" class="space-y-4">
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700 flex items-center" for="rejectionReason">
                                <i class="fas fa-comment-dots text-gray-400 ml-2"></i>
                                סיבת הדחייה *
                            </label>
                            <textarea class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-iec-blue focus:border-iec-blue resize-none" id="rejectionReason" rows="4" required placeholder="הסבר את הסיבה לדחיית הבקשה"></textarea>
                        </div>
                        <div class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3 rtl:space-x-reverse pt-4">
                            <button class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors duration-200 uk-modal-close flex items-center justify-center space-x-2 rtl:space-x-reverse" type="button">
                                <i class="fas fa-times"></i>
                                <span>ביטול</span>
                            </button>
                            <button class="px-6 py-2 bg-iec-red hover:bg-red-600 text-white rounded-md transition-colors duration-200 flex items-center justify-center space-x-2 rtl:space-x-reverse" type="submit">
                                <i class="fas fa-ban"></i>
                                <span>דחה בקשה</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            SUPABASE_URL: 'https://gxjgomnjtjtughcxawoz.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4amdvbW5qdGp0dWdoY3hhd296Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzNjg1OTEsImV4cCI6MjA3MTk0NDU5MX0.PI1gvtRk5BKYr97Eu9lFSpUyfYJindWAwfCBsrjB_bA',
            
            NTFY_ADMIN_TOPIC: 'request-admin-iec',
            NTFY_STATUS_TOPIC: 'iec-deployment-status'
        };

        // Global variables
        let supabase;
        let currentUser = null;
        let isAdmin = false;
        let currentRejectRequestId = null;
        let showTodayOnly = true; // Default to showing only today's requests

        // Users array for dropdown selection
        const users = [
            { name: "מירית בינשטוק", email: "mbinshtock@abra-it.com" },
            { name: "רואי רדלר", email: "roei.redler@abra-it.com" },
            { name: "מיכל פישר", email: "michal.fisher@iec.co.il" },
            { name: "את'יר אברהם", email: "etri.abrahem@iec.co.il" },
            { name: "שקד אהרון", email: "Shaked.Ah@abra-it.com" },
            { name: "גדי כהן", email: "Gadi.Cohen@abrait.onmicrosoft.com" },
            { name: "רחל כץ דגני", email: "Rachel.Katz.Degany@abra-it.com" },
            { name: "ציפורה שלטי", email: "zshalti@abra-it.com" },
            { name: "שירי קסירר", email: "Shiri.Kassirer@abra-it.com" }
        ];

        // Dark mode functions
        function toggleDarkMode() {
            const html = document.documentElement;
            const icon = document.getElementById('dark-mode-icon');
            
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                icon.className = 'fas fa-moon';
                localStorage.setItem('darkMode', 'false');
            } else {
                html.classList.add('dark');
                icon.className = 'fas fa-sun';
                localStorage.setItem('darkMode', 'true');
            }
            
            // Update skeleton if currently visible
            updateSkeletonTheme();
        }

        // Update skeleton theme when dark mode is toggled
        function updateSkeletonTheme() {
            const container = document.getElementById('allRequests');
            const mobileSkeleton = document.getElementById('mobileSkeleton');
            
            // Only update if skeleton is currently visible
            if (container && (mobileSkeleton || container.querySelector('.animate-pulse'))) {
                showSkeletonLoading(); // Refresh the skeleton with current theme
            }
        }

        function initDarkMode() {
            const html = document.documentElement;
            const icon = document.getElementById('dark-mode-icon');
            const savedMode = localStorage.getItem('darkMode');
            
            // Only check saved preference, default to light mode
            if (savedMode === 'true') {
                html.classList.add('dark');
                if (icon) icon.className = 'fas fa-sun';
            } else {
                html.classList.remove('dark');
                if (icon) icon.className = 'fas fa-moon';
            }
        }

        // Toggle date filter between today only and all dates
        function toggleDateFilter(showToday) {
            showTodayOnly = showToday;
            
            const todayBtn = document.getElementById('todayFilterBtn');
            const allDatesBtn = document.getElementById('allDatesBtn');
            
            if (showToday) {
                // Active state for "today only"
                todayBtn.style.backgroundColor = '#3B82F6';
                todayBtn.style.color = 'white';
                todayBtn.style.borderColor = '#3B82F6';
                
                // Inactive state for "all dates"
                allDatesBtn.style.backgroundColor = '#F3F4F6';
                allDatesBtn.style.color = '#374151';
                allDatesBtn.style.borderColor = '#D1D5DB';
            } else {
                // Inactive state for "today only"
                todayBtn.style.backgroundColor = '#F3F4F6';
                todayBtn.style.color = '#374151';
                todayBtn.style.borderColor = '#D1D5DB';
                
                // Active state for "all dates"
                allDatesBtn.style.backgroundColor = '#3B82F6';
                allDatesBtn.style.color = 'white';
                allDatesBtn.style.borderColor = '#3B82F6';
            }
            
            // Reload the requests with the new filter
            loadAllRequests();
        }

        // Show new request modal
        function showNewRequestModal() {
            document.getElementById('newRequestModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        // Close new request modal
        function closeNewRequestModal() {
            document.getElementById('newRequestModal').classList.add('hidden');
            document.body.style.overflow = ''; // Restore background scrolling
            
            // Reset the drag interface when modal closes
            setTimeout(() => {
                resetDragInterface();
            }, 100);
        }

        // Show admin login modal
        function showAdminLogin() {
            UIkit.modal('#adminLoginModal').show();
        }

        // Show reject modal
        function showRejectModal(requestId) {
            currentRejectRequestId = requestId;
            UIkit.modal('#rejectModal').show();
        }

        // Mobile navigation toggle (kept for compatibility)
        function closeMobileNav() {
            // This function is no longer needed but kept for compatibility
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initDarkMode(); // Initialize dark mode first
            initSupabase();
            setupEventListeners();
            populateUserDropdowns();
            checkAuthState();
            loadAllRequests(); // Load public requests on page load
        });

        // Populate user dropdowns
        function populateUserDropdowns() {
            const nameSelect = document.getElementById('requesterName');
            const emailSelect = document.getElementById('requesterEmail');
            
            // Clear existing options (except the first placeholder)
            nameSelect.innerHTML = '<option value="">בחר משתמש</option>';
            emailSelect.innerHTML = '<option value="">בחר אימייל</option>';
            
            // Populate name dropdown
            users.forEach(user => {
                const nameOption = document.createElement('option');
                nameOption.value = user.name;
                nameOption.textContent = user.name;
                nameSelect.appendChild(nameOption);
                
                const emailOption = document.createElement('option');
                emailOption.value = user.email;
                emailOption.textContent = user.email;
                emailSelect.appendChild(emailOption);
            });
        }

        // Update email when name is selected
        function updateRequesterEmail() {
            const selectedName = document.getElementById('requesterName').value;
            const emailSelect = document.getElementById('requesterEmail');
            
            if (selectedName) {
                const user = users.find(u => u.name === selectedName);
                if (user) {
                    emailSelect.value = user.email;
                }
            } else {
                emailSelect.value = '';
            }
        }

        // Update name when email is selected
        function updateRequesterName() {
            const selectedEmail = document.getElementById('requesterEmail').value;
            const nameSelect = document.getElementById('requesterName');
            
            if (selectedEmail) {
                const user = users.find(u => u.email === selectedEmail);
                if (user) {
                    nameSelect.value = user.name;
                }
            } else {
                nameSelect.value = '';
            }
        }

        function initSupabase() {
            try {
                supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
                console.log('Supabase initialized successfully');
            } catch (error) {
                console.error('Error initializing Supabase:', error);
                showMessage('שגיאה באתחול המערכת. בדוק את הגדרות Supabase.', 'error');
            }
        }

        function setupEventListeners() {
            console.log('Setting up event listeners...'); // Debug log
            
            document.getElementById('submitForm').addEventListener('submit', handleSubmitRequest);
            document.getElementById('adminLoginForm').addEventListener('submit', handleAdminLogin);
            document.getElementById('rejectForm').addEventListener('submit', handleRejectRequest);
            
            // Single unified function for all environment changes
            const handleEnvironmentChange = function() {
                console.log('🔄 Environment change detected - checking current state');
                checkAndUpdateEnvironmentFlow();
            };
            
            // Source environment listeners
            const sourceEnv = document.getElementById('sourceEnv');
            if (sourceEnv) {
                console.log('Setting up source environment listeners');
                sourceEnv.addEventListener('change', handleEnvironmentChange);
                sourceEnv.addEventListener('input', handleEnvironmentChange);
                sourceEnv.addEventListener('click', handleEnvironmentChange);
            }
            
            // Target environment listeners
            const targetEnv = document.getElementById('targetEnv');
            if (targetEnv) {
                console.log('Setting up target environment listeners');
                targetEnv.addEventListener('change', handleEnvironmentChange);
                targetEnv.addEventListener('input', handleEnvironmentChange);
                targetEnv.addEventListener('click', handleEnvironmentChange);
            }
            
            // Modal event listeners
            const modal = document.getElementById('newRequestModal');
            if (modal) {
                // Close modal when clicking outside
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeNewRequestModal();
                    }
                });
                
                // Close modal when pressing Escape
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                        closeNewRequestModal();
                    }
                });
            }
            
            // Setup drag-to-submit functionality
            setupDragToSubmit();
            
            console.log('Event listeners setup complete');
        }

        // Drag to Submit functionality
        function setupDragToSubmit() {
            const container = document.querySelector('.drag-submit-container');
            const track = document.querySelector('.drag-submit-track');
            const button = document.querySelector('.drag-submit-button');
            const text = document.querySelector('.drag-submit-text');
            const textDisabled = document.querySelector('.drag-submit-text-disabled');
            const successElement = document.querySelector('.drag-submit-success');
            
            if (!container || !track || !button || !text) {
                console.error('Drag to submit elements not found');
                return;
            }
            
            let isDragging = false;
            let startX = 0;
            let currentX = 0;
            let maxDistance = 0;
            let progressElement = null;
            
            // Validate required fields
            function validateRequiredFields() {
                const requiredFields = [
                    'requesterName',
                    'requesterEmail', 
                    'appId',
                    'urgency',
                    'sourceEnv',
                    'targetEnv',
                    'description'
                ];
                
                for (let fieldId of requiredFields) {
                    const field = document.getElementById(fieldId);
                    if (!field || !field.value.trim()) {
                        return false;
                    }
                }
                return true;
            }
            
            // Update drag button state based on validation
            function updateDragButtonState() {
                const isValid = validateRequiredFields();
                
                if (isValid) {
                    // Enable drag
                    track.classList.remove('disabled');
                    button.classList.remove('disabled');
                    text.classList.remove('disabled');
                    text.classList.remove('hidden');
                    textDisabled.classList.add('hidden');
                } else {
                    // Disable drag
                    track.classList.add('disabled');
                    button.classList.add('disabled');
                    text.classList.add('disabled');
                    text.classList.add('hidden');
                    textDisabled.classList.remove('hidden');
                }
                
                return isValid;
            }
            
            // Initial state check
            updateDragButtonState();
            
            // Add listeners to all required fields to update state
            const requiredFields = ['requesterName', 'requesterEmail', 'appId', 'urgency', 'sourceEnv', 'targetEnv', 'description'];
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', updateDragButtonState);
                    field.addEventListener('change', updateDragButtonState);
                }
            });
            
            // Create progress indicator
            function createProgressIndicator() {
                if (!progressElement) {
                    progressElement = document.createElement('div');
                    progressElement.className = 'drag-progress';
                    track.appendChild(progressElement);
                }
            }
            
            // Update progress (RTL: progress fills from left to right)
            function updateProgress(distance) {
                if (progressElement) {
                    const percentage = Math.min((distance / maxDistance) * 100, 100);
                    progressElement.style.width = percentage + '%';
                }
            }
            
            // Mouse events
            button.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', endDrag);
            
            // Touch events for mobile
            button.addEventListener('touchstart', startDrag, { passive: false });
            document.addEventListener('touchmove', drag, { passive: false });
            document.addEventListener('touchend', endDrag);
            
            function startDrag(e) {
                // Check if form is valid before allowing drag
                if (!updateDragButtonState()) {
                    e.preventDefault();
                    // Show a message about missing fields
                    showMessage('אנא השלם את כל השדות הנדרשים לפני השליחה', 'error');
                    return;
                }
                
                e.preventDefault();
                isDragging = true;
                
                const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
                startX = clientX;
                
                // Calculate max distance (track width - button width - padding)
                maxDistance = track.offsetWidth - button.offsetWidth - 8;
                
                createProgressIndicator();
                
                track.classList.add('dragging');
                button.classList.add('dragging');
                text.classList.add('fading');
                
                // Change cursor
                document.body.style.cursor = 'grabbing';
            }
            
            function drag(e) {
                if (!isDragging) return;
                
                e.preventDefault();
                const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
                currentX = clientX - startX;
                
                // Constrain movement (RTL: positive movement to the right)
                currentX = Math.max(0, Math.min(currentX, maxDistance));
                
                // Move button (RTL: move from left to right)
                button.style.transform = `translateY(-50%) translateX(${currentX}px)`;
                
                // Update progress
                updateProgress(currentX);
                
                // Update text opacity based on progress
                const progress = currentX / maxDistance;
                text.style.opacity = 1 - progress;
            }
            
            function endDrag(e) {
                if (!isDragging) return;
                
                isDragging = false;
                document.body.style.cursor = '';
                
                const progress = currentX / maxDistance;
                
                if (progress >= 0.8) {
                    // Double-check validation before submission
                    if (validateRequiredFields()) {
                        completeSubmission();
                    } else {
                        showMessage('אנא השלם את כל השדות הנדרשים', 'error');
                        resetDragButton();
                    }
                } else {
                    // Reset to original position
                    resetDragButton();
                }
            }
            
            function completeSubmission() {
                // Hide track and show success
                track.style.display = 'none';
                successElement.classList.remove('hidden');
                
                // Show immediate success feedback
                successElement.innerHTML = `
                    <span class="text-white font-medium flex items-center space-x-2 rtl:space-x-reverse">
                        <i class="fas fa-check"></i>
                        <span>הבקשה נשלחה!</span>
                    </span>
                `;
                
                // Wait a moment to show success, then trigger form submission
                setTimeout(() => {
                    const form = document.getElementById('submitForm');
                    if (form) {
                        // Create a custom submit event
                        const submitEvent = new Event('submit', {
                            bubbles: true,
                            cancelable: true
                        });
                        form.dispatchEvent(submitEvent);
                    }
                }, 800); // Increased delay to show success feedback
            }
            
            function resetDragButton() {
                // Animate back to original position (RTL: back to left side)
                button.style.transition = 'transform 0.3s ease';
                button.style.transform = 'translateY(-50%) translateX(0)';
                
                // Reset classes and progress
                track.classList.remove('dragging');
                button.classList.remove('dragging');
                text.classList.remove('fading');
                text.style.opacity = '';
                
                if (progressElement) {
                    progressElement.style.width = '0%';
                }
                
                // Remove transition after animation
                setTimeout(() => {
                    button.style.transition = '';
                }, 300);
            }
        }

        // Unified function that always checks current state and updates visuals
        function checkAndUpdateEnvironmentFlow() {
            const sourceEnv = document.getElementById('sourceEnv');
            const targetEnv = document.getElementById('targetEnv');
            
            if (!sourceEnv || !targetEnv) {
                console.error('Environment elements not found');
                return;
            }
            
            const sourceValue = sourceEnv.value;
            const targetValue = targetEnv.value;
            
            console.log(`🔍 Current state: Source="${sourceValue}", Target="${targetValue}"`);
            
            // Always reset visuals first
            resetEnvironmentVisuals();
            
            // Disable same environment options
            updateEnvironmentOptions(sourceValue, targetValue);
            
            // Check current state and update visuals accordingly
            if (sourceValue && targetValue) {
                console.log(`✅ Both selected: ${sourceValue} -> ${targetValue}`);
                handleBothEnvironmentsSelected(sourceValue, targetValue);
            } else if (sourceValue && !targetValue) {
                console.log(`📤 Only source selected: ${sourceValue}`);
                handleOnlySourceSelected(sourceValue);
            } else if (!sourceValue && targetValue) {
                console.log(`📥 Only target selected: ${targetValue}`);
                handleOnlyTargetSelected(targetValue);
            } else {
                console.log('❌ Neither selected');
                hideEnvironmentFeedback();
            }
        }

        // Handle when both environments are selected
        function handleBothEnvironmentsSelected(source, target) {
            // Show the visual flow
            showEnvironmentFlow(source, target);
            
            // Show appropriate validation message based on combination
            if (source === target) {
                showValidationMessage('invalid', 'לא ניתן להעביר אפליקציה לאותה סביבה. אנא בחר סביבת יעד שונה.');
            } else if (source === 'dev' && target === 'test') {
                showValidationMessage('valid', '✅ מעולה! זהו המסלול הטבעי מפיתוח לבדיקות.');
            } else if (source === 'test' && target === 'prod') {
                showValidationMessage('valid', '✅ מעולה! זהו המסלול הטבעי מבדיקות לייצור.');
            } else if (source === 'dev' && target === 'prod') {
                console.log('🚨 DEV->PROD detected - showing warning');
                showValidationMessage('invalid', '⚠️ לא מומלץ להעביר ישירות מפיתוח לייצור! עבור דרך סביבת הבדיקות תחילה.');
            } else if (source === 'prod') {
                showValidationMessage('recommend', 'העברה מייצור - וודא שזה נדרש (תיקון חם).');
            } else {
                showValidationMessage('recommend', 'צירוף סביבות לא שגרתי. וודא שזה נדרש.');
            }
            
            // Show help text
            showEnvironmentHelp('source', source);
            showEnvironmentHelp('target', target);
        }

        // Handle when only source is selected
        function handleOnlySourceSelected(source) {
            const targetEnv = document.getElementById('targetEnv');
            
            // Auto-suggest target based on best practice
            if (source === 'dev') {
                targetEnv.value = 'test';
                handleBothEnvironmentsSelected(source, 'test');
            } else if (source === 'test') {
                targetEnv.value = 'prod';
                handleBothEnvironmentsSelected(source, 'prod');
            } else if (source === 'prod') {
                // Don't auto-suggest for prod, show only source
                const sourceEl = document.getElementById(`env-${source}`);
                if (sourceEl) {
                    sourceEl.classList.remove('opacity-50');
                    sourceEl.classList.add('opacity-100');
                    applyEnvironmentColor(source, 'source');
                }
                showValidationMessage('recommend', 'ייצור הוא סביבת היעד הסופית. בחר סביבת יעד.');
            }
            
            showEnvironmentHelp('source', source);
        }

        // Handle when only target is selected
        function handleOnlyTargetSelected(target) {
            const targetEl = document.getElementById(`env-${target}`);
            if (targetEl) {
                targetEl.classList.remove('opacity-50');
                targetEl.classList.add('opacity-100');
                applyEnvironmentColor(target, 'target');
            }
            
            const flowStatus = document.getElementById('flowStatus');
            const flowStatusText = document.getElementById('flowStatusText');
            if (flowStatus && flowStatusText) {
                flowStatus.classList.remove('hidden');
                flowStatusText.textContent = `העברה ל${getEnvironmentName(target)} - בחר סביבת מקור`;
            }
            
            showValidationMessage('recommend', 'בחר סביבת מקור כדי לראות את מסלול ההעברה המלא.');
            showEnvironmentHelp('target', target);
        }

        // Update environment options (disable same environment)
        function updateEnvironmentOptions(sourceValue, targetValue) {
            const sourceEnv = document.getElementById('sourceEnv');
            const targetEnv = document.getElementById('targetEnv');
            
            // Disable same environment in target options
            for (let option of targetEnv.options) {
                option.disabled = option.value === sourceValue;
            }
            
            // Disable same environment in source options
            for (let option of sourceEnv.options) {
                option.disabled = option.value === targetValue;
            }
        }

        async function checkAuthState() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    isAdmin = true; // Any logged-in user is automatically an admin
                    updateUI();
                    loadAllRequests();
                }
            } catch (error) {
                console.error('Error checking auth state:', error);
            }
        }

        function updateUI() {
            const loginBtn = document.getElementById('admin-login-btn');
            const logoutBtn = document.getElementById('admin-logout-btn');
            const userInfo = document.getElementById('user-info');
            
            if (currentUser) {
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                userInfo.classList.remove('hidden');
                userInfo.textContent = `מחובר: ${currentUser.email} (מנהל)`;
            } else {
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                userInfo.classList.add('hidden');
            }
        }

        async function handleAdminLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                currentUser = data.user;
                isAdmin = true; // Any logged-in user is automatically an admin
                updateUI();
                
                // Close the admin login modal
                UIkit.modal('#adminLoginModal').hide();
                
                showMessage('התחברת בהצלחה כמנהל!', 'success');
                loadAllRequests();
                
            } catch (error) {
                console.error('Login error:', error);
                showMessage('שגיאה בהתחברות: ' + error.message, 'error');
            }
        }

        async function adminLogout() {
            try {
                await supabase.auth.signOut();
                currentUser = null;
                isAdmin = false;
                updateUI();
                showMessage('התנתקת בהצלחה', 'success');
                
            } catch (error) {
                console.error('Logout error:', error);
                showMessage('שגיאה בהתנתקות: ' + error.message, 'error');
            }
        }

        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected section and activate tab
            document.getElementById(sectionName + '-section').classList.add('active');
            document.getElementById(sectionName + '-btn').classList.add('active');
        }

        // Legacy functions kept for compatibility, now just call the unified function
        function updateTargetOptions() {
            console.log('updateTargetOptions called - redirecting to unified function');
            checkAndUpdateEnvironmentFlow();
        }
        
        function updateSourceOptions() {
            console.log('updateSourceOptions called - redirecting to unified function');
            checkAndUpdateEnvironmentFlow();
        }
        
        function showEnvironmentFlow(source, target) {
            console.log(`showEnvironmentFlow called: ${source} -> ${target}`); // Debug log
            
            // Reset all environments
            resetEnvironmentVisuals();
            
            // Validate that the DOM elements exist
            const sourceEl = document.getElementById(`env-${source}`);
            const targetEl = target ? document.getElementById(`env-${target}`) : null;
            
            if (!sourceEl) {
                console.error(`Source environment element not found: env-${source}`);
                return;
            }
            
            // Highlight source environment with its specific color
            sourceEl.classList.remove('opacity-50');
            sourceEl.classList.add('opacity-100');
            applyEnvironmentColor(source, 'source');
            
            // Highlight target environment and show flow
            if (target && targetEl) {
                targetEl.classList.remove('opacity-50');
                targetEl.classList.add('opacity-100');
                applyEnvironmentColor(target, 'target');
                
                // Animate the flow arrows
                animateFlow(source, target);
                
                // Show flow status
                const flowStatus = document.getElementById('flowStatus');
                const flowStatusText = document.getElementById('flowStatusText');
                if (flowStatus && flowStatusText) {
                    flowStatus.classList.remove('hidden');
                    flowStatusText.textContent = `העברה מ${getEnvironmentName(source)} ל${getEnvironmentName(target)}`;
                    
                    // Add special styling for warning flows
                    if (source === 'dev' && target === 'prod') {
                        flowStatus.className = flowStatus.className.replace('bg-white', 'bg-orange-50');
                        flowStatus.className = flowStatus.className.replace('border-gray-200', 'border-orange-200');
                        flowStatusText.innerHTML = `⚠️ העברה מ${getEnvironmentName(source)} ל${getEnvironmentName(target)} - לא מומלץ!`;
                    } else {
                        flowStatus.className = flowStatus.className.replace('bg-orange-50', 'bg-white');
                        flowStatus.className = flowStatus.className.replace('border-orange-200', 'border-gray-200');
                    }
                } else {
                    console.error('Flow status elements not found');
                }
            }
        }
        
        function animateFlow(source, target) {
            console.log(`animateFlow called: ${source} -> ${target}`); // Debug log
            
            const envOrder = ['dev', 'test', 'prod'];
            const sourceIndex = envOrder.indexOf(source);
            const targetIndex = envOrder.indexOf(target);
            
            console.log(`Indices: source=${sourceIndex}, target=${targetIndex}`); // Debug log
            
            // Determine if this is a valid or warning flow
            const isValidFlow = (source === 'dev' && target === 'test') || 
                               (source === 'test' && target === 'prod') ||
                               (source === 'prod');
            const isWarningFlow = (source === 'dev' && target === 'prod');
            
            console.log(`Flow type: valid=${isValidFlow}, warning=${isWarningFlow}`); // Debug log
            
            // Choose arrow colors and animations based on flow type
            const arrowColor = isWarningFlow ? 'warning-flow-arrow' : 'text-blue-500';
            const pulseClass = isWarningFlow ? 'animate-bounce-warning' : 'animate-pulse';
            
            // For dev->prod, animate through test environment to show the full path
            if (source === 'dev' && target === 'prod') {
                console.log('Handling dev->prod special case'); // Debug log
                
                // Highlight the intermediate test environment with a warning indication
                const testEl = document.getElementById('env-test');
                if (testEl) {
                    testEl.classList.remove('opacity-50');
                    testEl.classList.add('opacity-75');
                    const testBorder = testEl.querySelector('.border-2');
                    if (testBorder) {
                        testBorder.classList.add('border-dashed');
                        testBorder.classList.add('warning-flow-test');
                    }
                } else {
                    console.error('Test environment element not found');
                }
                
                // Animate both arrows with warning style
                [1, 2].forEach((arrowNum, index) => {
                    const arrow = document.getElementById(`arrow-${arrowNum}`);
                    if (arrow) {
                        console.log(`Animating arrow ${arrowNum}`); // Debug log
                        arrow.classList.remove('text-gray-400');
                        arrow.classList.add(arrowColor, pulseClass);
                        
                        // Add a slight delay for each arrow
                        setTimeout(() => {
                            arrow.style.transform = 'scale(1.2)';
                            setTimeout(() => {
                                arrow.style.transform = 'scale(1)';
                            }, 200);
                        }, index * 150);
                    } else {
                        console.error(`Arrow ${arrowNum} element not found`);
                    }
                });
            } else {
                console.log('Handling standard flow'); // Debug log
                
                // Standard flow animation
                for (let i = sourceIndex; i < targetIndex; i++) {
                    const arrow = document.getElementById(`arrow-${i + 1}`);
                    if (arrow) {
                        console.log(`Animating standard arrow ${i + 1}`); // Debug log
                        arrow.classList.remove('text-gray-400');
                        arrow.classList.add(arrowColor, pulseClass);
                        
                        // Add a slight delay for each arrow
                        setTimeout(() => {
                            arrow.style.transform = 'scale(1.2)';
                            setTimeout(() => {
                                arrow.style.transform = 'scale(1)';
                            }, 200);
                        }, i * 100);
                    } else {
                        console.error(`Standard arrow ${i + 1} element not found`);
                    }
                }
            }
        }
        
        function resetEnvironmentVisuals() {
            // Reset all environment circles to gray
            ['dev', 'test', 'prod'].forEach(env => {
                const envEl = document.getElementById(`env-${env}`);
                envEl.classList.remove('opacity-100', 'opacity-75');
                envEl.classList.add('opacity-50');
                const border = envEl.querySelector('.border-2');
                border.classList.remove('border-4', 'shadow-lg', 'ring-2', 'ring-blue-300', 'ring-green-300', 'border-dashed', 'border-orange-300', 'warning-flow-test');
                
                // Reset to gray colors
                resetEnvironmentToGray(env);
            });
            
            // Reset arrows
            [1, 2].forEach(num => {
                const arrow = document.getElementById(`arrow-${num}`);
                arrow.classList.remove('text-blue-500', 'text-orange-500', 'warning-flow-arrow', 'animate-pulse', 'animate-bounce', 'animate-bounce-warning');
                arrow.classList.add('text-gray-400');
                arrow.style.transform = 'scale(1)';
            });
            
            // Hide flow status
            document.getElementById('flowStatus').classList.add('hidden');
        }
        
        function resetEnvironmentToGray(env) {
            const envEl = document.getElementById(`env-${env}`);
            if (!envEl) return;
            
            const circle = envEl.querySelector('.w-16.h-16');
            const icon = circle.querySelector('i');
            const label = envEl.querySelector('.text-sm.font-medium');
            
            // Reset to gray styling
            circle.className = 'w-16 h-16 bg-gray-100 border-2 border-gray-300 rounded-full flex items-center justify-center';
            icon.className = `fas ${getEnvironmentIcon(env)} text-gray-600 text-xl`;
            label.className = 'text-sm font-medium text-gray-700';
        }
        
        function applyEnvironmentColor(env, type = 'source') {
            const envEl = document.getElementById(`env-${env}`);
            if (!envEl) return;
            
            const circle = envEl.querySelector('.w-16.h-16');
            const icon = circle.querySelector('i');
            const label = envEl.querySelector('.text-sm.font-medium');
            
            const colors = getEnvironmentColors(env);
            const ringColor = type === 'source' ? 'ring-blue-300' : 'ring-green-300';
            
            // Apply environment-specific colors
            circle.className = `w-16 h-16 ${colors.bg} border-2 ${colors.border} rounded-full flex items-center justify-center`;
            icon.className = `fas ${getEnvironmentIcon(env)} ${colors.text} text-xl`;
            label.className = `text-sm font-medium ${colors.labelText}`;
            
            // Add ring effect
            circle.classList.add('border-4', 'shadow-lg', 'ring-2', ringColor);
        }
        
        function getEnvironmentColors(env) {
            const colors = {
                'dev': {
                    bg: 'bg-orange-100',
                    border: 'border-orange-300',
                    text: 'text-orange-600',
                    labelText: 'text-orange-700'
                },
                'test': {
                    bg: 'bg-yellow-100',
                    border: 'border-yellow-300',
                    text: 'text-yellow-600',
                    labelText: 'text-yellow-700'
                },
                'prod': {
                    bg: 'bg-green-100',
                    border: 'border-green-300',
                    text: 'text-green-600',
                    labelText: 'text-green-700'
                }
            };
            return colors[env] || {
                bg: 'bg-gray-100',
                border: 'border-gray-300',
                text: 'text-gray-600',
                labelText: 'text-gray-700'
            };
        }
        
        function getEnvironmentIcon(env) {
            const icons = {
                'dev': 'fa-code',
                'test': 'fa-flask',
                'prod': 'fa-globe'
            };
            return icons[env] || 'fa-layer-group';
        }
        
        function showEnvironmentHelp(type, env) {
            const helpId = type === 'source' ? 'sourceEnvHelp' : 'targetEnvHelp';
            const helpEl = document.getElementById(helpId);
            
            if (env) {
                helpEl.classList.remove('hidden');
            } else {
                helpEl.classList.add('hidden');
            }
        }
        
        function validateEnvironmentCombination(source, target) {
            const validationEl = document.getElementById('environmentValidation');
            const validEl = document.getElementById('validCombination');
            const invalidEl = document.getElementById('invalidCombination');
            const recommendEl = document.getElementById('recommendedFlow');
            const validText = document.getElementById('validCombinationText');
            const invalidText = document.getElementById('invalidCombinationText');
            
            // Hide all validation messages first
            [validEl, invalidEl, recommendEl].forEach(el => el.classList.add('hidden'));
            
            if (source === target) {
                validationEl.classList.remove('hidden');
                invalidEl.classList.remove('hidden');
                invalidText.textContent = 'לא ניתן להעביר אפליקציה לאותה סביבה. אנא בחר סביבת יעד שונה.';
                return;
            }
            
            const validCombinations = {
                'dev': ['test'],
                'test': ['prod'],
                'prod': ['dev', 'test'] // For hotfixes
            };
            
            validationEl.classList.remove('hidden');
            
            if (validCombinations[source]?.includes(target)) {
                validEl.classList.remove('hidden');
                if (source === 'dev' && target === 'test') {
                    validText.textContent = 'מעולה! זהו המסלול הטבעי מפיתוח לבדיקות.';
                } else if (source === 'test' && target === 'prod') {
                    validText.textContent = 'מעולה! זהו המסלול הטבעי מבדיקות לייצור.';
                } else if (source === 'prod') {
                    validText.textContent = 'העברה חריגה מייצור. וודא שזה נדרש (תיקון חם).';
                }
            } else {
                invalidEl.classList.remove('hidden');
                if (source === 'dev' && target === 'prod') {
                    invalidText.textContent = 'לא מומלץ להעביר ישירות מפיתוח לייצור! עבור דרך סביבת הבדיקות תחילה.';
                } else {
                    invalidText.textContent = 'צירוף סביבות לא שגרתי. וודא שזה נדרש.';
                }
                recommendEl.classList.remove('hidden');
            }
        }
        
        function showValidationMessage(type, message) {
            const validationEl = document.getElementById('environmentValidation');
            const validEl = document.getElementById('validCombination');
            const invalidEl = document.getElementById('invalidCombination');
            const recommendEl = document.getElementById('recommendedFlow');
            
            // Hide all first
            [validEl, invalidEl, recommendEl].forEach(el => el.classList.add('hidden'));
            
            validationEl.classList.remove('hidden');
            
            if (type === 'valid') {
                validEl.classList.remove('hidden');
                document.getElementById('validCombinationText').textContent = message;
            } else if (type === 'invalid') {
                invalidEl.classList.remove('hidden');
                document.getElementById('invalidCombinationText').textContent = message;
            } else if (type === 'recommend') {
                recommendEl.classList.remove('hidden');
            }
        }
        
        function getEnvironmentName(env) {
            const names = {
                'dev': 'פיתוח',
                'test': 'בדיקות',
                'prod': 'ייצור'
            };
            return names[env] || env;
        }
        
        function hideEnvironmentFeedback() {
            resetEnvironmentVisuals();
            document.getElementById('environmentValidation').classList.add('hidden');
            showEnvironmentHelp('source', '');
            showEnvironmentHelp('target', '');
        }

        // Test function for debugging - can be called from browser console
        window.testEnvironmentFlow = function(source, target) {
            console.log(`🧪 Testing flow: ${source} -> ${target}`);
            document.getElementById('sourceEnv').value = source;
            document.getElementById('targetEnv').value = target;
            checkAndUpdateEnvironmentFlow(); // Use the unified function
        };

        // Manual trigger function for when automatic detection fails
        window.refreshEnvironmentFlow = function() {
            console.log(`🔄 Manual refresh called`);
            checkAndUpdateEnvironmentFlow();
        };

        // Quick test for dev->prod specifically
        window.testDevToProd = function() {
            console.log('🚨 Testing DEV->PROD flow specifically');
            document.getElementById('sourceEnv').value = 'dev';
            document.getElementById('targetEnv').value = 'prod';
            checkAndUpdateEnvironmentFlow();
        };

        // Test all combinations
        window.testAllCombinations = function() {
            const combinations = [
                ['dev', 'test'],
                ['dev', 'prod'],
                ['test', 'prod'],
                ['prod', 'dev'],
                ['prod', 'test']
            ];
            
            let index = 0;
            const testNext = () => {
                if (index < combinations.length) {
                    const [source, target] = combinations[index];
                    console.log(`Testing combination ${index + 1}: ${source} -> ${target}`);
                    testEnvironmentFlow(source, target);
                    index++;
                    setTimeout(testNext, 2000); // Wait 2 seconds between tests
                }
            };
            testNext();
        };

        // Add keyboard event listener for manual refresh (Ctrl+R in the form)
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey && event.key === 'r') {
                const activeElement = document.activeElement;
                if (activeElement && (activeElement.id === 'sourceEnv' || activeElement.id === 'targetEnv')) {
                    event.preventDefault();
                    window.refreshEnvironmentFlow();
                }
            }
        });

        // Global variables for sorting and filtering
        let currentSortColumn = 'created_at';
        let currentSortDirection = 'desc';
        let filteredRequests = [];

        // Search and filter function
        function filterRequests() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            if (!window.currentRequestsData) return;
            
            filteredRequests = window.currentRequestsData.filter(request => {
                const matchesSearch = searchTerm === '' || 
                    request.id.toString().includes(searchTerm) ||
                    request.app_id.toLowerCase().includes(searchTerm) ||
                    request.requester_name.toLowerCase().includes(searchTerm) ||
                    request.requester_email.toLowerCase().includes(searchTerm) ||
                    request.description.toLowerCase().includes(searchTerm);
                
                const matchesStatus = statusFilter === '' || request.status === statusFilter;
                
                return matchesSearch && matchesStatus;
            });
            
            // Apply current sorting
            sortRequestsData(filteredRequests, currentSortColumn, currentSortDirection);
            
            // Re-render the table with filtered data
            renderRequestsTable(filteredRequests);
            renderMobileCards(filteredRequests);
        }

        // Sort table function
        function sortTable(column) {
            // Toggle sort direction if clicking the same column
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }
            
            // Update sort indicators
            updateSortIndicators(column, currentSortDirection);
            
            // Get current displayed data (filtered or all)
            const dataToSort = filteredRequests.length > 0 ? filteredRequests : window.currentRequestsData;
            
            if (dataToSort) {
                sortRequestsData(dataToSort, column, currentSortDirection);
                renderRequestsTable(dataToSort);
                renderMobileCards(dataToSort);
            }
        }

        // Sort requests data
        function sortRequestsData(data, column, direction) {
            data.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                // Handle different data types
                if (column === 'created_at') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                } else if (column === 'id') {
                    aVal = parseInt(aVal);
                    bVal = parseInt(bVal);
                } else if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (direction === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
        }

        // Update sort indicators
        function updateSortIndicators(activeColumn, direction) {
            // Remove all sort classes
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
            });
            
            // Add sort class to active column
            const activeHeader = document.querySelector(`[data-sort="${activeColumn}"]`);
            if (activeHeader) {
                activeHeader.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc');
            }
        }

        // Get environment styling
        function getEnvironmentStyle(env) {
            const envStyles = {
                'dev': {
                    color: 'bg-orange-100 text-orange-800',
                    icon: 'fas fa-code'
                },
                'test': {
                    color: 'bg-yellow-100 text-yellow-800',
                    icon: 'fas fa-flask'
                },
                'prod': {
                    color: 'bg-green-100 text-green-800',
                    icon: 'fas fa-globe'
                }
            };
            
            return envStyles[env] || {
                color: 'bg-gray-100 text-gray-800',
                icon: 'fas fa-layer-group'
            };
        }

        // Render requests table
        function renderRequestsTable(requests) {
            const tbody = document.getElementById('requestsTableBody');
            if (!tbody) return;
            
            let html = '';
            
            requests.forEach(request => {
                const urgencyBorderClass = request.urgency === 'high' ? 'border-r-4 border-orange-400' : 
                                          request.urgency === 'critical' ? 'border-r-4 border-red-500' : '';
                
                let statusBadgeClass = 'bg-yellow-100 text-yellow-800';
                let urgencyTextClass = 'text-gray-600';
                
                if (request.status === 'approved') statusBadgeClass = 'bg-green-100 text-green-800';
                else if (request.status === 'rejected') statusBadgeClass = 'bg-red-100 text-red-800';
                
                if (request.urgency === 'high') urgencyTextClass = 'text-orange-600';
                else if (request.urgency === 'critical') urgencyTextClass = 'text-red-600';
                
                html += `
                    <tr class="hover:bg-gray-50 transition-colors duration-150 ${urgencyBorderClass}" data-request-id="${request.id}">
                        <td class="px-3 py-4 whitespace-nowrap text-center">
                            <button class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-md transition-colors duration-150" 
                                    onclick="toggleRequestDetails(${request.id})" 
                                    title="לחץ להרחבת פרטים">
                                <i class="fas fa-plus text-sm"></i>
                            </button>
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-center text-sm font-medium text-gray-900">#${request.id}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-center text-sm text-gray-900 hidden sm:table-cell">${request.app_id}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-center hidden md:table-cell">
                            <div class="text-sm">
                                <div class="font-medium text-gray-900">${request.requester_name}</div>
                                <div class="text-gray-500">${request.requester_email}</div>
                            </div>
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-center hidden lg:table-cell">
                            <div class="flex items-center justify-center space-x-2 rtl:space-x-reverse">
                                <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium ${getEnvironmentStyle(request.source_env).color}">
                                    <i class="${getEnvironmentStyle(request.source_env).icon} ml-1"></i>
                                    ${request.source_env}
                                </span>
                                <i class="fas fa-arrow-left text-gray-400 text-xs"></i>
                                <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium ${getEnvironmentStyle(request.target_env).color}">
                                    <i class="${getEnvironmentStyle(request.target_env).icon} ml-1"></i>
                                    ${request.target_env}
                                </span>
                            </div>
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-center text-sm ${urgencyTextClass} hidden md:table-cell">
                            ${getUrgencyText(request.urgency)}
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-center">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusBadgeClass}">
                                ${getStatusText(request.status)}
                            </span>
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-center text-sm text-gray-500 hidden sm:table-cell">
                            ${new Date(request.created_at).toLocaleDateString('he-IL')}
                        </td>
                        ${isAdmin ? `
                            <td class="px-3 py-4 whitespace-nowrap text-center hidden lg:table-cell">
                                ${request.status === 'pending' ? `
                                    <div class="flex flex-col sm:flex-row items-center justify-center space-y-1 sm:space-y-0 sm:space-x-2 rtl:space-x-reverse">
                                        <button class="px-3 py-1 bg-green-100 hover:bg-green-200 text-green-800 rounded-md text-xs font-medium transition-colors duration-150 flex items-center space-x-1 rtl:space-x-reverse" 
                                                onclick="testApprove(${request.id})" 
                                                title="אשר בקשה">
                                            <i class="fas fa-check"></i>
                                            <span>אשר</span>
                                        </button>
                                        <button class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-800 rounded-md text-xs font-medium transition-colors duration-150 flex items-center space-x-1 rtl:space-x-reverse" 
                                                onclick="testReject(${request.id})" 
                                                title="דחה בקשה">
                                            <i class="fas fa-times"></i>
                                            <span>דחה</span>
                                        </button>
                                    </div>
                                ` : '<span class="text-gray-400 text-sm">-</span>'}
                            </td>
                        ` : ''}
                    </tr>
                    <tr class="hidden bg-gray-50" id="details-${request.id}">
                        <td colspan="${isAdmin ? '9' : '8'}" class="px-6 py-4">
                            <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
                                <h5 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                    <i class="fas fa-info-circle text-blue-500 ml-2"></i>
                                    פרטי הבקשה
                                </h5>
                                
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div class="space-y-4">
                                        <div>
                                            <span class="block text-sm font-medium text-gray-700 mb-1">תיאור השינוי:</span>
                                            <p class="text-sm text-gray-900 bg-gray-50 p-3 rounded-md">${request.description}</p>
                                        </div>
                                    </div>
                                    <div class="space-y-3">
                                        <div>
                                            <span class="block text-sm font-medium text-gray-700">תאריך יצירה:</span>
                                            <span class="text-sm text-gray-900">${new Date(request.created_at).toLocaleString('he-IL')}</span>
                                        </div>
                                        <div>
                                            <span class="block text-sm font-medium text-gray-700">תאריך עדכון:</span>
                                            <span class="text-sm text-gray-900">${new Date(request.updated_at).toLocaleString('he-IL')}</span>
                                        </div>
                                        ${request.status === 'approved' && request.approved_by ? `
                                            <div>
                                                <span class="block text-sm font-medium text-green-700">בוצע על ידי:</span>
                                                <span class="text-sm text-green-900">${request.approved_by}</span>
                                            </div>
                                        ` : ''}
                                        ${request.status === 'approved' && request.approved_at ? `
                                            <div>
                                                <span class="block text-sm font-medium text-green-700">תאריך ביצוע:</span>
                                                <span class="text-sm text-green-900">${new Date(request.approved_at).toLocaleString('he-IL')}</span>
                                            </div>
                                        ` : ''}
                                        ${request.status === 'rejected' && request.rejected_by ? `
                                            <div>
                                                <span class="block text-sm font-medium text-red-700">נדחה על ידי:</span>
                                                <span class="text-sm text-red-900">${request.rejected_by}</span>
                                            </div>
                                        ` : ''}
                                        ${request.status === 'rejected' && request.rejected_at ? `
                                            <div>
                                                <span class="block text-sm font-medium text-red-700">תאריך דחייה:</span>
                                                <span class="text-sm text-red-900">${new Date(request.rejected_at).toLocaleString('he-IL')}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                                
                                ${request.rejection_reason ? `
                                    <div class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                                        <h6 class="text-sm font-semibold text-red-800 mb-2 flex items-center">
                                            <i class="fas fa-exclamation-triangle ml-1"></i>
                                            סיבת הדחייה:
                                        </h6>
                                        <p class="text-sm text-red-700">${request.rejection_reason}</p>
                                    </div>
                                ` : ''}
                                
                                ${isAdmin && request.status === 'pending' ? `
                                    <div class="mt-6 pt-4 border-t border-gray-200">
                                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 rtl:space-x-reverse">
                                            <button class="px-4 py-2 bg-green-100 hover:bg-green-200 text-green-800 rounded-md font-medium transition-colors duration-150 flex items-center justify-center space-x-2 rtl:space-x-reverse" onclick="testApprove(${request.id})">
                                                <i class="fas fa-check"></i>
                                                <span>אשר בקשה</span>
                                            </button>
                                            <button class="px-4 py-2 bg-red-100 hover:bg-red-200 text-red-800 rounded-md font-medium transition-colors duration-150 flex items-center justify-center space-x-2 rtl:space-x-reverse" onclick="testReject(${request.id})">
                                                <i class="fas fa-times"></i>
                                                <span>דחה בקשה</span>
                                            </button>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function updateSourceOptions() {
            const targetEnv = document.getElementById('targetEnv').value;
            const sourceEnv = document.getElementById('sourceEnv');
            
            for (let option of sourceEnv.options) {
                option.disabled = option.value === targetEnv;
                if (option.value === targetEnv && option.selected) {
                    sourceEnv.value = '';
                }
            }
        }

        async function handleSubmitRequest(event) {
            event.preventDefault();
            
            // Check if this is a drag-initiated submission
            const dragContainer = document.querySelector('.drag-submit-container');
            const successElement = document.querySelector('.drag-submit-success');
            
            // Show loading state in the success element
            if (successElement && !successElement.classList.contains('hidden')) {
                successElement.innerHTML = `
                    <span class="text-white font-medium flex items-center space-x-2 rtl:space-x-reverse">
                        <div uk-spinner="ratio: 0.5" class="text-white"></div>
                        <span>שולח...</span>
                    </span>
                `;
            }
            
            const formData = {
                requester_name: document.getElementById('requesterName').value,
                requester_email: document.getElementById('requesterEmail').value,
                app_id: document.getElementById('appId').value,
                source_env: document.getElementById('sourceEnv').value,
                target_env: document.getElementById('targetEnv').value,
                description: document.getElementById('description').value,
                urgency: document.getElementById('urgency').value,
                status: 'pending',
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            try {
                // Create table if it doesn't exist
                await createTableIfNotExists();
                
                // Insert request
                const { data, error } = await supabase
                    .from('version_requests')
                    .insert([formData])
                    .select();
                
                if (error) throw error;
                
                const requestId = data[0].id;
                
                // Send notification
                await sendAdminNotification(formData, requestId);
                
                // Show success message
                showMessage(`הבקשה נשלחה בהצלחה! מזהה בקשה: ${requestId}`, 'success');
                
                // Reset form
                document.getElementById('submitForm').reset();
                
                // Close modal
                closeNewRequestModal();
                
                // Refresh the public requests list
                loadAllRequests();
                
            } catch (error) {
                console.error('Error submitting request:', error);
                showMessage('שגיאה בשליחת הבקשה: ' + error.message, 'error');
                
                // Reset drag interface on error
                resetDragInterface();
            } finally {
                // Reset any remaining button states
                const submitBtn = document.querySelector('#submitForm button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = false;
                }
            }
        }
        
        // Helper function to reset drag interface
        function resetDragInterface() {
            const track = document.querySelector('.drag-submit-track');
            const successElement = document.querySelector('.drag-submit-success');
            const button = document.querySelector('.drag-submit-button');
            const text = document.querySelector('.drag-submit-text');
            const textDisabled = document.querySelector('.drag-submit-text-disabled');
            
            if (track && successElement) {
                // Reset visual states
                track.style.display = 'flex';
                successElement.classList.add('hidden');
                
                // Reset button position and state
                if (button) {
                    button.style.transform = 'translateY(-50%) translateX(0)';
                    button.style.transition = '';
                }
                
                // Reset text states
                if (text) {
                    text.style.opacity = '';
                    text.classList.remove('fading');
                }
                
                // Reset success element content
                successElement.innerHTML = `
                    <span class="text-white font-medium flex items-center space-x-2 rtl:space-x-reverse">
                        <i class="fas fa-check"></i>
                        <span>נשלח!</span>
                    </span>
                `;
                
                // Remove any progress indicators
                const progressElement = track.querySelector('.drag-progress');
                if (progressElement) {
                    progressElement.remove();
                }
                
                // Reset classes
                track.classList.remove('dragging', 'completed');
                if (button) {
                    button.classList.remove('dragging');
                }
                
                // Re-validate and update button state
                setTimeout(() => {
                    const setupDragToSubmitInstance = window.setupDragToSubmitInstance;
                    if (setupDragToSubmitInstance && typeof setupDragToSubmitInstance.updateDragButtonState === 'function') {
                        setupDragToSubmitInstance.updateDragButtonState();
                    }
                }, 100);
            }
        }

        async function createTableIfNotExists() {
            // This function attempts to create the table if it doesn't exist
            // Using raw SQL through Supabase RPC function
            const { error } = await supabase.rpc('create_version_requests_table', {});
            
            if (error && !error.message.includes('already exists')) {
                console.warn('Could not create table automatically:', error);
            }
        }

        async function sendAdminNotification(requestData, requestId) {
            const urgencyEmoji = {
                'low': '🟢',
                'medium': '🟡', 
                'high': '🟠',
                'critical': '🔴'
            };

            const message = `${urgencyEmoji[requestData.urgency]} בקשה חדשה להעברת גרסה

🆔 מזהה אפליקציה: ${requestData.app_id}
👤 מבקש: ${requestData.requester_name}
🔄 מ-${requestData.source_env} ל-${requestData.target_env}
⚡ דחיפות: ${requestData.urgency}

מזהה בקשה: ${requestId}`;

            try {
                await fetch(`https://ntfy.sh/${CONFIG.NTFY_ADMIN_TOPIC}`, {
                    method: 'POST',
                    body: message,
                    headers: {
                        'Priority': 'urgent'
                    }
                });
            } catch (error) {
                console.error('Error sending notification:', error);
            }
        }

        async function sendStatusNotification(requestData, status, adminUser, reason = null) {
            const statusEmoji = {
                'approved': '✅',
                'rejected': '❌'
            };

            const statusText = {
                'approved': 'בוצעה',
                'rejected': 'נדחתה'
            };

            let message = `${statusEmoji[status]} בקשת העברת גרסה ${statusText[status]}

🆔 מזהה בקשה: #${requestData.id}
📱 אפליקציה: ${requestData.app_id}
👤 מבקש: ${requestData.requester_name}
🔄 העברה: ${requestData.source_env} → ${requestData.target_env}
👨‍💼 ${status === 'approved' ? 'בוצע על ידי' : 'נדחה על ידי'}: ${adminUser}
📅 תאריך: ${new Date().toLocaleString('he-IL')}`;

            if (status === 'rejected' && reason) {
                message += `\n📝 סיבת דחייה: ${reason}`;
            }

            try {
                await fetch(`https://ntfy.sh/${CONFIG.NTFY_STATUS_TOPIC}`, {
                    method: 'POST',
                    body: message,
                    headers: {
                        'Priority': 'urgent'
                    }
                });
                console.log('Status notification sent successfully');
            } catch (error) {
                console.error('Error sending status notification:', error);
            }
        }

        async function loadAllRequests() {
            const statusFilter = document.getElementById('statusFilter').value;
            const statusFilterElement = document.getElementById('statusFilter');
            
            // Show skeleton loading immediately
            showSkeletonLoading();
            const startTime = Date.now();
            
            try {
                let query = supabase
                    .from('version_requests')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                // Apply status filter if selected
                if (statusFilter) {
                    query = query.eq('status', statusFilter);
                }
                
                // Apply date filter if showing today only
                if (showTodayOnly) {
                    const today = new Date();
                    const startOfDay = new Date(today.setHours(0, 0, 0, 0)).toISOString();
                    const endOfDay = new Date(today.setHours(23, 59, 59, 999)).toISOString();
                    
                    query = query.gte('created_at', startOfDay).lte('created_at', endOfDay);
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                // Ensure minimum 2 second loading time for better UX
                const elapsedTime = Date.now() - startTime;
                const remainingTime = Math.max(0, 1200 - elapsedTime);
                
                setTimeout(() => {
                    // Check if we're filtering by "pending" and got no results
                    if (statusFilter === 'pending' && data.length === 0) {
                        // Auto-switch to "All Statuses" if no pending requests found
                        statusFilterElement.value = '';
                        
                        // Reload with all statuses but keep the date filter
                        let allQuery = supabase
                            .from('version_requests')
                            .select('*')
                            .order('created_at', { ascending: false });
                        
                        // Apply date filter to the "all statuses" query too
                        if (showTodayOnly) {
                            const today = new Date();
                            const startOfDay = new Date(today.setHours(0, 0, 0, 0)).toISOString();
                            const endOfDay = new Date(today.setHours(23, 59, 59, 999)).toISOString();
                            
                            allQuery = allQuery.gte('created_at', startOfDay).lte('created_at', endOfDay);
                        }
                        
                        allQuery.then(({ data: allData, error: allError }) => {
                            if (allError) throw allError;
                            
                            displayPublicRequestsWithTransition(allData);
                            
                            // Show informative message
                            const timeFilter = showTodayOnly ? ' מהיום' : '';
                            showMessage(`לא נמצאו בקשות ממתינות לביצוע${timeFilter}. מציג את כל הבקשות${timeFilter}.`, 'warning');
                        });
                    } else {
                        displayPublicRequestsWithTransition(data);
                        
                        // Show filter status message if we have results
                        if (data.length > 0 && showTodayOnly) {
                            showMessage(`מציג ${data.length} בקשות מהיום בלבד`, 'success');
                        } else if (data.length === 0 && showTodayOnly) {
                            showMessage('לא נמצאו בקשות מהיום. נסה לבחור "כל התאריכים" כדי לראות בקשות מתאריכים קודמים.', 'info');
                        }
                    }
                }, remainingTime);
                
            } catch (error) {
                // Ensure minimum loading time even on error
                const elapsedTime = Date.now() - startTime;
                const remainingTime = Math.max(0, 2000 - elapsedTime);
                
                setTimeout(() => {
                    console.error('Error loading requests:', error);
                    const container = document.getElementById('allRequests');
                    hideSkeletonWithTransition(`
                        <div class="bg-red-50 dark:bg-red-900 border border-red-200 dark:border-red-700 rounded-lg p-4 text-center">
                            <i class="fas fa-exclamation-circle text-red-500 text-2xl mb-2"></i>
                            <p class="text-red-800 dark:text-red-200 font-medium">שגיאה בטעינת הבקשות</p>
                        </div>
                    `);
                    showMessage('שגיאה בטעינת הבקשות: ' + error.message, 'error');
                }, remainingTime);
            }
        }

        // Display requests with smooth transition from skeleton
        function displayPublicRequestsWithTransition(requests) {
            // Create a temporary container to build the content
            const tempContainer = document.createElement('div');
            tempContainer.id = 'allRequests';
            
            // Call the original display function with the temp container
            const originalContainer = document.getElementById('allRequests');
            document.body.appendChild(tempContainer);
            
            // Temporarily override the container reference
            const originalGetElement = document.getElementById;
            document.getElementById = function(id) {
                if (id === 'allRequests') return tempContainer;
                return originalGetElement.call(document, id);
            };
            
            // Generate the content
            displayPublicRequests(requests);
            
            // Restore the original getElementById
            document.getElementById = originalGetElement;
            
            // Get the generated content
            const newContent = tempContainer.innerHTML;
            
            // Clean up temp container
            document.body.removeChild(tempContainer);
            
            // Apply the transition
            hideSkeletonWithTransition(newContent);
        }

        // Generate the HTML content for requests (extracted from displayPublicRequests)
        function generateRequestsHTML(requests) {
            if (requests.length === 0) {
                return `
                    <div class="bg-yellow-50 dark:bg-yellow-900 border border-yellow-200 dark:border-yellow-700 rounded-lg p-4 text-center">
                        <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl mb-2"></i>
                        <p class="text-yellow-800 dark:text-yellow-200 font-medium">אין בקשות להצגה</p>
                    </div>
                `;
            }
            
            // This will be implemented based on the existing displayPublicRequests structure
            return '';
        }

        // Show skeleton loading animation
        function showSkeletonLoading() {
            const container = document.getElementById('allRequests');
            const isDark = document.documentElement.classList.contains('dark');
            
            // Dynamic theme classes based on current mode
            const cardBg = isDark ? 'bg-gray-800' : 'bg-white';
            const cardBorder = isDark ? 'border-gray-700' : 'border-gray-200';
            const skeletonColor = isDark ? 'bg-gray-600' : 'bg-gray-300';
            const tableBg = isDark ? 'bg-gray-900' : 'bg-white';
            const tableHeaderBg = isDark ? 'bg-gray-800' : 'bg-gray-50';
            const tableBorder = isDark ? 'border-gray-700' : 'border-gray-200';
            const tableDivide = isDark ? 'divide-gray-700' : 'divide-gray-200';
            const hoverBg = isDark ? 'hover:bg-gray-800' : 'hover:bg-gray-50';
            
            const skeletonHTML = `
                <!-- Mobile Skeleton Cards (visible on small screens) -->
                <div class="block md:hidden space-y-4 animate-pulse" id="mobileSkeleton">
                    ${Array(3).fill().map(() => `
                        <div class="${cardBg} rounded-lg shadow-sm border ${cardBorder} p-4">
                            <div class="flex justify-between items-start mb-3">
                                <div class="h-4 ${skeletonColor} rounded w-24"></div>
                                <div class="h-6 ${skeletonColor} rounded-full w-16"></div>
                            </div>
                            <div class="space-y-2">
                                <div class="h-4 ${skeletonColor} rounded w-3/4"></div>
                                <div class="h-4 ${skeletonColor} rounded w-1/2"></div>
                                <div class="h-4 ${skeletonColor} rounded w-2/3"></div>
                            </div>
                            <div class="flex justify-between items-center mt-4">
                                <div class="h-4 ${skeletonColor} rounded w-20"></div>
                                <div class="h-8 ${skeletonColor} rounded w-16"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <!-- Desktop Skeleton Table (hidden on small screens) -->
                <div class="hidden md:block overflow-x-auto shadow-sm border ${tableBorder} rounded-lg animate-pulse">
                    <table class="min-w-full divide-y ${tableDivide}">
                        <thead class="${tableHeaderBg}">
                            <tr>
                                <th class="px-3 py-3 text-center">
                                    <div class="h-4 ${skeletonColor} rounded w-12 mx-auto"></div>
                                </th>
                                <th class="px-3 py-3 text-center">
                                    <div class="h-4 ${skeletonColor} rounded w-20 mx-auto"></div>
                                </th>
                                <th class="px-3 py-3 text-center">
                                    <div class="h-4 ${skeletonColor} rounded w-24 mx-auto"></div>
                                </th>
                                <th class="px-3 py-3 text-center">
                                    <div class="h-4 ${skeletonColor} rounded w-16 mx-auto"></div>
                                </th>
                                <th class="px-3 py-3 text-center">
                                    <div class="h-4 ${skeletonColor} rounded w-16 mx-auto"></div>
                                </th>
                                <th class="px-3 py-3 text-center">
                                    <div class="h-4 ${skeletonColor} rounded w-12 mx-auto"></div>
                                </th>
                                <th class="px-3 py-3 text-center">
                                    <div class="h-4 ${skeletonColor} rounded w-16 mx-auto"></div>
                                </th>
                                <th class="px-3 py-3 text-center">
                                    <div class="h-4 ${skeletonColor} rounded w-20 mx-auto"></div>
                                </th>
                            </tr>
                        </thead>
                        <tbody class="${tableBg} divide-y ${tableDivide}">
                            ${Array(5).fill().map((_, index) => `
                                <tr class="${hoverBg}">
                                    <td class="px-3 py-4 text-center">
                                        <div class="h-6 ${skeletonColor} rounded w-8 mx-auto"></div>
                                    </td>
                                    <td class="px-3 py-4 text-center">
                                        <div class="h-4 ${skeletonColor} rounded w-16 mx-auto"></div>
                                    </td>
                                    <td class="px-3 py-4 text-center">
                                        <div class="h-4 ${skeletonColor} rounded w-20 mx-auto"></div>
                                    </td>
                                    <td class="px-3 py-4 text-center">
                                        <div class="h-4 ${skeletonColor} rounded w-24 mx-auto"></div>
                                    </td>
                                    <td class="px-3 py-4 text-center">
                                        <div class="flex items-center justify-center space-x-1 rtl:space-x-reverse">
                                            <div class="h-6 ${skeletonColor} rounded w-12"></div>
                                            <div class="h-4 ${skeletonColor} rounded w-4"></div>
                                            <div class="h-6 ${skeletonColor} rounded w-12"></div>
                                        </div>
                                    </td>
                                    <td class="px-3 py-4 text-center">
                                        <div class="h-6 ${skeletonColor} rounded-full w-16 mx-auto"></div>
                                    </td>
                                    <td class="px-3 py-4 text-center">
                                        <div class="h-4 ${skeletonColor} rounded w-20 mx-auto"></div>
                                    </td>
                                    <td class="px-3 py-4 text-center">
                                        <div class="h-8 ${skeletonColor} rounded w-16 mx-auto"></div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = skeletonHTML;
        }

        // Hide skeleton with smooth transition and show actual content
        function hideSkeletonWithTransition(actualContent) {
            const container = document.getElementById('allRequests');
            
            // First, fade out the skeleton
            container.style.opacity = '0.5';
            container.style.transition = 'opacity 0.3s ease-in-out';
            
            setTimeout(() => {
                // Replace content
                container.innerHTML = actualContent;
                container.style.opacity = '0';
                
                // Fade in the new content
                setTimeout(() => {
                    container.style.opacity = '1';
                }, 50);
            }, 150);
        }

        function displayPublicRequests(requests) {
            const container = document.getElementById('allRequests');
            
            console.log('Displaying requests. isAdmin:', isAdmin);
            console.log('Number of requests:', requests.length);
            
            if (requests.length === 0) {
                container.innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                        <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl mb-2"></i>
                        <p class="text-yellow-800 font-medium">אין בקשות להצגה</p>
                    </div>
                `;
                return;
            }
            
            // Create responsive layout: cards for mobile, table for desktop
            let html = `
                <!-- Mobile Card View (visible on small screens) -->
                <div class="block md:hidden space-y-4" id="mobileCardsContainer">
                </div>
                
                <!-- Desktop Table View (hidden on small screens) -->
                <div class="hidden md:block overflow-x-auto shadow-sm border border-gray-200 rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-16">פרטים</th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header cursor-pointer hover:bg-gray-100 transition-colors" onclick="sortTable('id')" data-sort="id">
                                    מזהה בקשה
                                </th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header cursor-pointer hover:bg-gray-100 transition-colors" onclick="sortTable('app_id')" data-sort="app_id">
                                    מזהה אפליקציה
                                </th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header cursor-pointer hover:bg-gray-100 transition-colors" onclick="sortTable('requester_name')" data-sort="requester_name">
                                    מבקש
                                </th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header cursor-pointer hover:bg-gray-100 transition-colors" onclick="sortTable('source_env')" data-sort="source_env">
                                    העברה
                                </th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header cursor-pointer hover:bg-gray-100 transition-colors" onclick="sortTable('urgency')" data-sort="urgency">
                                    דחיפות
                                </th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header cursor-pointer hover:bg-gray-100 transition-colors" onclick="sortTable('status')" data-sort="status">
                                    סטטוס
                                </th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header cursor-pointer hover:bg-gray-100 transition-colors" onclick="sortTable('created_at')" data-sort="created_at">
                                    תאריך
                                </th>
                                ${isAdmin ? '<th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">פעולות</th>' : ''}
                            </tr>
                        </thead>
                        <tbody id="requestsTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Store the current data for sorting and filtering
            window.currentRequestsData = requests;
            filteredRequests = [...requests]; // Copy all requests initially
            
            // Apply default sorting (by creation date, newest first)
            sortRequestsData(filteredRequests, 'created_at', 'desc');
            currentSortColumn = 'created_at';
            currentSortDirection = 'desc';
            
            // Render both table and cards
            renderRequestsTable(filteredRequests);
            renderMobileCards(filteredRequests);
            
            // Update sort indicators
            updateSortIndicators('created_at', 'desc');
        }

        // Render mobile cards
        function renderMobileCards(requests) {
            const container = document.getElementById('mobileCardsContainer');
            if (!container) return;
            
            let html = '';
            
            requests.forEach(request => {
                const urgencyBorderClass = request.urgency === 'high' ? 'border-l-4 border-orange-400' : 
                                          request.urgency === 'critical' ? 'border-l-4 border-red-500' : 'border-l-4 border-gray-200';
                
                let statusBadgeClass = 'bg-yellow-100 text-yellow-800';
                let urgencyTextClass = 'text-gray-600';
                
                if (request.status === 'approved') statusBadgeClass = 'bg-green-100 text-green-800';
                else if (request.status === 'rejected') statusBadgeClass = 'bg-red-100 text-red-800';
                
                if (request.urgency === 'high') urgencyTextClass = 'text-orange-600';
                else if (request.urgency === 'critical') urgencyTextClass = 'text-red-600';
                
                html += `
                    <div class="bg-white rounded-lg shadow-sm border ${urgencyBorderClass} p-4 hover:shadow-md transition-shadow duration-150">
                        <!-- Header with request ID and status -->
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex items-center space-x-2 rtl:space-x-reverse">
                                <span class="text-lg font-semibold text-gray-900">#${request.id}</span>
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusBadgeClass}">
                                    ${getStatusText(request.status)}
                                </span>
                            </div>
                            <button class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-md transition-colors duration-150" 
                                    onclick="toggleMobileCardDetails('mobile-card-${request.id}')" 
                                    title="לחץ להרחבת פרטים">
                                <i class="fas fa-chevron-down text-sm"></i>
                            </button>
                        </div>
                        
                        <!-- App ID and main info -->
                        <div class="space-y-2 mb-3">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-500">אפליקציה:</span>
                                <span class="text-sm font-medium text-gray-900">${request.app_id}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-500">מבקש:</span>
                                <span class="text-sm text-gray-900">${request.requester_name}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-500">העברה:</span>
                                <div class="flex items-center space-x-2 rtl:space-x-reverse">
                                    <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium ${getEnvironmentStyle(request.source_env).color}">
                                        ${request.source_env}
                                    </span>
                                    <i class="fas fa-arrow-left text-gray-400 text-xs"></i>
                                    <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium ${getEnvironmentStyle(request.target_env).color}">
                                        ${request.target_env}
                                    </span>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-500">דחיפות:</span>
                                <span class="text-sm font-medium ${urgencyTextClass}">${getUrgencyText(request.urgency)}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-500">תאריך:</span>
                                <span class="text-sm text-gray-900">${new Date(request.created_at).toLocaleDateString('he-IL')}</span>
                            </div>
                        </div>
                        
                        <!-- Admin actions for pending requests -->
                        ${isAdmin && request.status === 'pending' ? `
                            <div class="flex space-x-2 rtl:space-x-reverse mb-3">
                                <button class="flex-1 px-3 py-2 bg-green-100 hover:bg-green-200 text-green-800 rounded-md text-sm font-medium transition-colors duration-150 flex items-center justify-center space-x-1 rtl:space-x-reverse" 
                                        onclick="testApprove(${request.id})" 
                                        title="אשר בקשה">
                                    <i class="fas fa-check"></i>
                                    <span>אשר</span>
                                </button>
                                <button class="flex-1 px-3 py-2 bg-red-100 hover:bg-red-200 text-red-800 rounded-md text-sm font-medium transition-colors duration-150 flex items-center justify-center space-x-1 rtl:space-x-reverse" 
                                        onclick="testReject(${request.id})" 
                                        title="דחה בקשה">
                                    <i class="fas fa-times"></i>
                                    <span>דחה</span>
                                </button>
                            </div>
                        ` : ''}
                        
                        <!-- Collapsible detailed info -->
                        <div class="hidden" id="mobile-card-${request.id}">
                            <div class="border-t border-gray-200 pt-3 mt-3 space-y-3">
                                <div>
                                    <span class="block text-sm font-medium text-gray-700 mb-1">תיאור השינוי:</span>
                                    <p class="text-sm text-gray-900 bg-gray-50 p-2 rounded-md">${request.description}</p>
                                </div>
                                <div>
                                    <span class="block text-sm font-medium text-gray-700 mb-1">אימייל מבקש:</span>
                                    <p class="text-sm text-gray-900">${request.requester_email}</p>
                                </div>
                                
                                ${request.status === 'approved' && request.approved_by ? `
                                    <div class="bg-green-50 p-3 rounded-md">
                                        <div class="text-sm">
                                            <span class="font-medium text-green-700">אושר על ידי:</span>
                                            <span class="text-green-900">${request.approved_by}</span>
                                        </div>
                                        ${request.approved_at ? `
                                            <div class="text-sm mt-1">
                                                <span class="font-medium text-green-700">תאריך ביצוע:</span>
                                                <span class="text-green-900">${new Date(request.approved_at).toLocaleString('he-IL')}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                ` : ''}
                                
                                ${request.status === 'rejected' && request.rejected_by ? `
                                    <div class="bg-red-50 p-3 rounded-md">
                                        <div class="text-sm">
                                            <span class="font-medium text-red-700">נדחה על ידי:</span>
                                            <span class="text-red-900">${request.rejected_by}</span>
                                        </div>
                                        ${request.rejected_at ? `
                                            <div class="text-sm mt-1">
                                                <span class="font-medium text-red-700">תאריך דחייה:</span>
                                                <span class="text-red-900">${new Date(request.rejected_at).toLocaleString('he-IL')}</span>
                                            </div>
                                        ` : ''}
                                        ${request.rejection_reason ? `
                                            <div class="text-sm mt-2">
                                                <span class="font-medium text-red-700">סיבת דחייה:</span>
                                                <p class="text-red-900 mt-1">${request.rejection_reason}</p>
                                            </div>
                                        ` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function toggleMobileCardDetails(cardId) {
            const detailsDiv = document.getElementById(cardId);
            const icon = event.target.closest('button').querySelector('i');
            
            if (detailsDiv.classList.contains('hidden')) {
                detailsDiv.classList.remove('hidden');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                detailsDiv.classList.add('hidden');
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        }

        function toggleRequestDetails(requestId) {
            console.log('Toggle called for request:', requestId);
            const detailsRow = document.getElementById(`details-${requestId}`);
            const expandBtn = document.querySelector(`tr[data-request-id="${requestId}"] button`);
            
            console.log('Found detailsRow:', detailsRow);
            console.log('Found expandBtn:', expandBtn);
            
            if (!detailsRow || !expandBtn) {
                console.error('Could not find elements for request:', requestId);
                alert('שגיאה: לא ניתן למצוא את פרטי הבקשה');
                return;
            }
            
            if (detailsRow.classList.contains('hidden')) {
                // Show details
                detailsRow.classList.remove('hidden');
                expandBtn.innerHTML = '<i class="fas fa-minus text-sm"></i>';
                expandBtn.classList.add('text-blue-600', 'bg-blue-50');
                expandBtn.classList.remove('text-gray-400', 'hover:text-gray-600');
                console.log('Expanded request:', requestId);
            } else {
                // Hide details
                detailsRow.classList.add('hidden');
                expandBtn.innerHTML = '<i class="fas fa-plus text-sm"></i>';
                expandBtn.classList.remove('text-blue-600', 'bg-blue-50');
                expandBtn.classList.add('text-gray-400', 'hover:text-gray-600');
                console.log('Collapsed request:', requestId);
            }
        }

        // Test functions for admin buttons
        function testApprove(requestId) {
            console.log('Approve clicked for request:', requestId);
            console.log('isAdmin:', isAdmin);
            approveRequest(requestId);
        }

        function testReject(requestId) {
            console.log('Reject clicked for request:', requestId);
            console.log('isAdmin:', isAdmin);
            showRejectModal(requestId);
        }

        function getUrgencyText(urgency) {
            const urgencyMap = {
                'low': '<i class="fas fa-flag urgency-icon" style="color: #28a745;"></i> נמוכה',
                'medium': '<i class="fas fa-flag urgency-icon" style="color: #ffc107;"></i> בינונית',
                'high': '<i class="fas fa-flag urgency-icon" style="color: #fd7e14;"></i> גבוהה',
                'critical': '<i class="fas fa-exclamation-triangle urgency-icon" style="color: #dc3545;"></i> קריטית'
            };
            return urgencyMap[urgency] || urgency;
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': '<i class="fas fa-clock status-icon" style="color: #ffc107;"></i> ממתין לביצוע',
                'approved': '<i class="fas fa-check-circle status-icon" style="color: #28a745;"></i> בוצע',
                'rejected': '<i class="fas fa-times-circle status-icon" style="color: #dc3545;"></i> נדחה'
            };
            return statusMap[status] || status;
        }

        async function approveRequest(requestId) {
            if (!confirm('האם אתה בטוח שברצונך לאשר את הבקשה?')) {
                return;
            }
            
            try {
                // Get current user
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                if (userError) throw userError;
                
                if (!user) {
                    showMessage('שגיאה: יש להתחבר כדי לאשר בקשות', 'error');
                    return;
                }

                // First get the request data before updating
                const { data: requestData, error: fetchError } = await supabase
                    .from('version_requests')
                    .select('*')
                    .eq('id', requestId)
                    .single();

                if (fetchError) throw fetchError;
                
                const { data, error } = await supabase
                    .from('version_requests')
                    .update({ 
                        status: 'approved', 
                        updated_at: new Date().toISOString(),
                        approved_by: user.email,
                        approved_at: new Date().toISOString()
                    })
                    .eq('id', requestId)
                    .select();
                
                if (error) throw error;
                
                // Send status notification
                await sendStatusNotification(requestData, 'approved', user.email);
                
                showMessage('הבקשה בוצעה בהצלחה!', 'success');
                loadAllRequests(); // Refresh view
                
            } catch (error) {
                console.error('Error approving request:', error);
                showMessage('שגיאה בביצוע הבקשה: ' + error.message, 'error');
            }
        }

        async function handleRejectRequest(event) {
            event.preventDefault();
            
            const reason = document.getElementById('rejectionReason').value;
            
            try {
                // Get current user
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                if (userError) throw userError;
                
                if (!user) {
                    showMessage('שגיאה: יש להתחבר כדי לדחות בקשות', 'error');
                    return;
                }

                // First get the request data before updating
                const { data: requestData, error: fetchError } = await supabase
                    .from('version_requests')
                    .select('*')
                    .eq('id', currentRejectRequestId)
                    .single();

                if (fetchError) throw fetchError;
                
                const { error } = await supabase
                    .from('version_requests')
                    .update({ 
                        status: 'rejected', 
                        rejection_reason: reason,
                        updated_at: new Date().toISOString(),
                        rejected_by: user.email,
                        rejected_at: new Date().toISOString()
                    })
                    .eq('id', currentRejectRequestId);
                
                if (error) throw error;
                
                // Send status notification with rejection reason
                await sendStatusNotification(requestData, 'rejected', user.email, reason);
                
                showMessage('הבקשה נדחתה בהצלחה!', 'success');
                
                // Reset form and close modal
                document.getElementById('rejectForm').reset();
                UIkit.modal('#rejectModal').hide();
                
                // Refresh views
                loadAllRequests();
                
            } catch (error) {
                console.error('Error rejecting request:', error);
                showMessage('שגיאה בדחיית הבקשה: ' + error.message, 'error');
            }
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            let bgClass = 'bg-blue-50 border-blue-200 text-blue-800';
            let iconClass = 'fas fa-info-circle text-blue-500';
            
            if (type === 'success') {
                bgClass = 'bg-green-50 border-green-200 text-green-800';
                iconClass = 'fas fa-check-circle text-green-500';
            } else if (type === 'error') {
                bgClass = 'bg-red-50 border-red-200 text-red-800';
                iconClass = 'fas fa-exclamation-circle text-red-500';
            } else if (type === 'warning') {
                bgClass = 'bg-yellow-50 border-yellow-200 text-yellow-800';
                iconClass = 'fas fa-exclamation-triangle text-yellow-500';
            }
            
            messageDiv.innerHTML = `
                <div class="rounded-lg border p-4 shadow-sm ${bgClass} transition-all duration-300 ease-in-out">
                    <div class="flex items-start">
                        <i class="${iconClass} mt-1 ml-2"></i>
                        <div class="flex-1">
                            <p class="text-sm font-medium">${message}</p>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600 ml-2">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                const alert = messageDiv.querySelector('div');
                if (alert) {
                    alert.style.opacity = '0';
                    alert.style.transform = 'translateY(-10px)';
                    setTimeout(() => {
                        messageDiv.innerHTML = '';
                    }, 300);
                }
            }, 5000);
        }

        // Check URL for request ID parameter and auto-load requests tab
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const requestId = urlParams.get('request');
            
        });
    </script>
</body>
</html>
